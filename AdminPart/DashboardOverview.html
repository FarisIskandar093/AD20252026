<div class="dashboard-container">
    <div class="welcome-header w3-purple">
        <h2>üëë Admin Dashboard Overview</h2>
        <p class="welcome-subtitle" id="adminDateTime">Loading system time...</p>
    </div>

    <!-- System Stats Grid -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <span class="card-icon">üë•</span>
                <h3 class="card-title">User Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h2 class="stat-value" id="totalStudents">0</h2>
                    <p class="stat-label">Total Students</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="totalLecturers">0</h2>
                    <p class="stat-label">Lecturers</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="activeUsers">0</h2>
                    <p class="stat-label">Active Today</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="adminCount">1</h2>
                    <p class="stat-label">Admins</p>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <span class="card-icon">üìö</span>
                <h3 class="card-title">Course Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h2 class="stat-value" id="totalCourses">0</h2>
                    <p class="stat-label">Courses</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="totalSections">0</h2>
                    <p class="stat-label">Sections</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="roomUtilization">0%</h2>
                    <p class="stat-label">Room Usage</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="clashCount">0</h2>
                    <p class="stat-label">Clashes</p>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <span class="card-icon">üè´</span>
                <h3 class="card-title">Room Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h2 class="stat-value" id="totalRooms">0</h2>
                    <p class="stat-label">Total Rooms</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="occupiedRooms">0</h2>
                    <p class="stat-label">Occupied</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="availableRooms">0</h2>
                    <p class="stat-label">Available</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="maintenance">0</h2>
                    <p class="stat-label">Maintenance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="classes-section">
        <div class="section-header">
            <h3 class="section-title">
                <span>‚ö°</span>
                <span>Quick Actions</span>
            </h3>
        </div>
        
        <div class="w3-row-padding w3-margin-top">
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/MasterDataView.html')">
                    <div class="w3-xxlarge">üìÅ</div>
                    <h4>View Master Data</h4>
                    <p>Raw TTMS data</p>
                </div>
            </div>
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/UserManagement.html')">
                    <div class="w3-xxlarge">üë•</div>
                    <h4>Manage Users</h4>
                    <p>User accounts</p>
                </div>
            </div>
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/RoomManagement.html')">
                    <div class="w3-xxlarge">üè´</div>
                    <h4>Room Management</h4>
                    <p>Allocate rooms</p>
                </div>
            </div>
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/SystemAnalytics.html')">
                    <div class="w3-xxlarge">üìà</div>
                    <h4>System Analytics</h4>
                    <p>Performance data</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="classes-section w3-margin-top">
        <div class="section-header">
            <h3 class="section-title">
                <span>üìã</span>
                <span>Recent System Activity</span>
            </h3>
        </div>
        
        <div id="recentActivity">
            <div class="class-card">
                <div class="w3-row">
                    <div class="w3-col m2 w3-center">
                        <span class="w3-tag w3-blue">INFO</span>
                    </div>
                    <div class="w3-col m8">
                        <strong>System initialized</strong><br>
                        <small>Admin dashboard loaded successfully</small>
                    </div>
                    <div class="w3-col m2 w3-right-align">
                        <small>Just now</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Visualizations Section -->
<div class="classes-section w3-margin-top">
    <div class="section-header">
        <h3 class="section-title">
            <span>üìä</span>
            <span>System Visualizations</span>
        </h3>
    </div>
    
    <div class="w3-row-padding">
        <!-- Student Distribution by Program -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding">
                <h4>Student Distribution by Program</h4>
                <div id="programChart" style="width:100%; height:300px;"></div>
            </div>
        </div>
        
        <!-- Room Utilization Heatmap -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding">
                <h4>Room Utilization Heatmap</h4>
                <div id="roomHeatmap" style="width:100%; height:300px;"></div>
            </div>
        </div>
    </div>
    
    <div class="w3-row-padding w3-margin-top">
        <!-- Course Enrollment Trends -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding">
                <h4>Course Enrollment Trends</h4>
                <div id="enrollmentChart" style="width:100%; height:300px;"></div>
            </div>
        </div>
        
        <!-- Time Slot Distribution -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding">
                <h4>Time Slot Distribution</h4>
                <div id="timeSlotChart" style="width:100%; height:300px;"></div>
            </div>
        </div>
    </div>
</div>
</div>

<script src="../JS/Authenticate.js"></script>
<script>
$(document).ready(function() {
    // Update date/time
    function updateDateTime() {
        const now = new Date();
        $("#adminDateTime").text(now.toLocaleString());
    }
    updateDateTime();
    setInterval(updateDateTime, 60000);
    
    // Load admin stats
    loadAdminStats();
    
    function loadAdminStats() {
        const adminSessionID = window.parent.adminSessionID;
        const currentSesi = window.parent.currentSesi;
        const currentSemester = window.parent.currentSemester;
        
        if (!adminSessionID) {
            console.warn("Admin session ID not available");
            return;
        }
        
        // Fetch student count
        fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSessionID}&sesi=${currentSesi}&semester=${currentSemester}&limit=5&offset=0`)
            .then(res => res.json())
            .then(students => {
                if (Array.isArray(students)) {
                    $("#totalStudents").text(students.length + "+");
                }
            })
            .catch(err => console.error("Error fetching students:", err));
            
        // Fetch course count
        fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek&sesi=${currentSesi}&semester=${currentSemester}`)
            .then(res => res.json())
            .then(courses => {
                if (Array.isArray(courses)) {
                    $("#totalCourses").text(courses.length);
                    
                    // Calculate total sections
                    const totalSections = courses.reduce((sum, course) => sum + (parseInt(course.bil_seksyen) || 0), 0);
                    $("#totalSections").text(totalSections);
                }
            })
            .catch(err => console.error("Error fetching courses:", err));
            
        // Fetch room count
        fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=ruang&kod_fakulti=fsksm`)
            .then(res => res.json())
            .then(rooms => {
                if (Array.isArray(rooms)) {
                    $("#totalRooms").text(rooms.length);
                    $("#availableRooms").text(Math.floor(rooms.length * 0.7)); // Placeholder
                }
            })
            .catch(err => console.error("Error fetching rooms:", err));
    }
});
</script>
<script>
// Load Google Charts
google.charts.load('current', {'packages':['corechart', 'bar']});
google.charts.setOnLoadCallback(loadEnhancedCharts);

function loadEnhancedCharts() {
    loadProgramDistribution();
    loadRoomHeatmap();
    loadEnrollmentTrends();
    loadTimeSlotDistribution();
}

function loadProgramDistribution() {
    const adminSessionID = window.parent.adminSessionID;
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSessionID}&sesi=${currentSesi}&semester=${currentSemester}&limit=100`)
        .then(res => res.json())
        .then(students => {
            if (!Array.isArray(students)) return;
            
            // Group by program
            const programCounts = {};
            students.forEach(student => {
                const program = student.kod_program || 'Unknown';
                programCounts[program] = (programCounts[program] || 0) + 1;
            });
            
            // Prepare chart data
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Program');
            data.addColumn('number', 'Students');
            
            Object.keys(programCounts).forEach(program => {
                data.addRow([program, programCounts[program]]);
            });
            
            const options = {
                title: 'Student Distribution by Program',
                pieHole: 0.4,
                backgroundColor: '#f5f5f5',
                colors: ['#9c27b0', '#2196f3', '#4caf50', '#ff9800', '#e91e63']
            };
            
            const chart = new google.visualization.PieChart(document.getElementById('programChart'));
            chart.draw(data, options);
        });
}

function loadRoomHeatmap() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${currentSesi}&semester=${currentSemester}&kod_ruang_like=N28&limit=100`)
        .then(res => res.json())
        .then(schedules => {
            if (!Array.isArray(schedules)) return;
            
            // Process room utilization
            const roomUtilization = {};
            schedules.forEach(schedule => {
                const room = schedule.kod_ruang;
                const day = schedule.hari;
                const time = schedule.masa;
                
                if (!roomUtilization[room]) {
                    roomUtilization[room] = {};
                }
                if (!roomUtilization[room][day]) {
                    roomUtilization[room][day] = 0;
                }
                roomUtilization[room][day]++;
            });
            
            // Prepare heatmap data
            const rooms = Object.keys(roomUtilization).slice(0, 10); // Top 10 rooms
            const days = [2, 3, 4, 5, 6]; // Monday to Friday
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Room');
            days.forEach(day => {
                const dayName = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][day-2];
                data.addColumn('number', dayName);
            });
            
            rooms.forEach(room => {
                const row = [room];
                days.forEach(day => {
                    row.push(roomUtilization[room][day] || 0);
                });
                data.addRow(row);
            });
            
            const options = {
                title: 'Room Utilization (Classes per Day)',
                hAxis: { title: 'Day of Week' },
                vAxis: { title: 'Room' },
                colors: ['#e0f2f1', '#80cbc4', '#26a69a', '#00897b', '#00695c']
            };
            
            const chart = new google.visualization.BarChart(document.getElementById('roomHeatmap'));
            chart.draw(data, options);
        });
}

function loadEnrollmentTrends() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek&sesi=${currentSesi}&semester=${currentSemester}`)
        .then(res => res.json())
        .then(courses => {
            if (!Array.isArray(courses)) return;
            
            // Sort by enrollment and take top 10
            const sortedCourses = courses
                .sort((a, b) => (b.bil_pelajar || 0) - (a.bil_pelajar || 0))
                .slice(0, 10);
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Course');
            data.addColumn('number', 'Enrollment');
            data.addColumn('number', 'Sections');
            
            sortedCourses.forEach(course => {
                data.addRow([
                    course.kod_subjek,
                    parseInt(course.bil_pelajar) || 0,
                    parseInt(course.bil_seksyen) || 0
                ]);
            });
            
            const options = {
                title: 'Top 10 Courses by Enrollment',
                hAxis: { title: 'Course Code' },
                vAxis: { title: 'Number of Students' },
                seriesType: 'bars',
                series: { 1: { type: 'line' } },
                colors: ['#2196f3', '#4caf50']
            };
            
            const chart = new google.visualization.ComboChart(document.getElementById('enrollmentChart'));
            chart.draw(data, options);
        });
}

function loadTimeSlotDistribution() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${currentSesi}&semester=${currentSemester}&limit=200`)
        .then(res => res.json())
        .then(schedules => {
            if (!Array.isArray(schedules)) return;
            
            // Count classes by time slot
            const timeSlots = {
                1: '8:00-9:00',
                2: '9:00-10:00',
                3: '10:00-11:00',
                4: '11:00-12:00',
                5: '12:00-13:00',
                7: '14:00-15:00',
                8: '15:00-16:00',
                9: '16:00-17:00',
                10: '17:00-18:00'
            };
            
            const slotCounts = {};
            schedules.forEach(schedule => {
                const slot = schedule.masa;
                slotCounts[slot] = (slotCounts[slot] || 0) + 1;
            });
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Time Slot');
            data.addColumn('number', 'Number of Classes');
            
            Object.keys(timeSlots).forEach(slot => {
                if (slotCounts[slot]) {
                    data.addRow([timeSlots[slot], slotCounts[slot]]);
                }
            });
            
            const options = {
                title: 'Class Distribution by Time Slot',
                hAxis: { title: 'Time' },
                vAxis: { title: 'Classes' },
                colors: ['#ff9800']
            };
            
            const chart = new google.visualization.ColumnChart(document.getElementById('timeSlotChart'));
            chart.draw(data, options);
        });
}
</script>