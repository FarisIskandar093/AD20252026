<div class="dashboard-container">
    <div class="welcome-header w3-purple">
        <h2>üëë Admin Dashboard Overview</h2>
        <p class="welcome-subtitle" id="adminDateTime">Loading system time...</p>
    </div>

    <!-- System Stats Grid -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-header">
                <span class="card-icon">üë•</span>
                <h3 class="card-title">User Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h2 class="stat-value" id="totalStudents">0</h2>
                    <p class="stat-label">Total Students</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="totalLecturers">0</h2>
                    <p class="stat-label">Lecturers</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="activeUsers">0</h2>
                    <p class="stat-label">Active Today</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="adminCount">1</h2>
                    <p class="stat-label">Admins</p>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <span class="card-icon">üìö</span>
                <h3 class="card-title">Course Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h2 class="stat-value" id="totalCourses">0</h2>
                    <p class="stat-label">Courses</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="totalSections">0</h2>
                    <p class="stat-label">Sections</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="roomUtilization">0%</h2>
                    <p class="stat-label">Room Usage</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="clashCount">0</h2>
                    <p class="stat-label">Clashes</p>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header">
                <span class="card-icon">üè´</span>
                <h3 class="card-title">Room Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <h2 class="stat-value" id="totalRooms">0</h2>
                    <p class="stat-label">Total Rooms</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="occupiedRooms">0</h2>
                    <p class="stat-label">Occupied</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="availableRooms">0</h2>
                    <p class="stat-label">Available</p>
                </div>
                <div class="stat-item">
                    <h2 class="stat-value" id="maintenance">0</h2>
                    <p class="stat-label">Maintenance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="classes-section">
        <div class="section-header">
            <h3 class="section-title">
                <span>‚ö°</span>
                <span>Quick Actions</span>
            </h3>
        </div>
        
        <div class="w3-row-padding w3-margin-top">
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/MasterDataView.html')">
                    <div class="w3-xxlarge">üìÅ</div>
                    <h4>View Master Data</h4>
                    <p>Raw TTMS data</p>
                </div>
            </div>
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/UserManagement.html')">
                    <div class="w3-xxlarge">üë•</div>
                    <h4>Manage Users</h4>
                    <p>User accounts</p>
                </div>
            </div>
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/RoomManagement.html')">
                    <div class="w3-xxlarge">üè´</div>
                    <h4>Room Management</h4>
                    <p>Allocate rooms</p>
                </div>
            </div>
            <div class="w3-col m3">
                <div class="w3-card w3-hover-shadow w3-padding w3-center" style="cursor:pointer;" onclick="loadAdminContent('AdminPart/SystemAnalytics.html')">
                    <div class="w3-xxlarge">üìà</div>
                    <h4>System Analytics</h4>
                    <p>Performance data</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="classes-section w3-margin-top">
        <div class="section-header">
            <h3 class="section-title">
                <span>üìã</span>
                <span>Recent System Activity</span>
            </h3>
        </div>
        
        <div id="recentActivity">
            <div class="class-card">
                <div class="w3-row">
                    <div class="w3-col m2 w3-center">
                        <span class="w3-tag w3-blue">INFO</span>
                    </div>
                    <div class="w3-col m8">
                        <strong>System initialized</strong><br>
                        <small>Admin dashboard loaded successfully</small>
                    </div>
                    <div class="w3-col m2 w3-right-align">
                        <small>Just now</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Visualizations Section -->
<div class="classes-section w3-margin-top">
    <div class="section-header">
        <h3 class="section-title">
            <span>üìä</span>
            <span>System Visualizations</span>
        </h3>
        <div class="w3-bar w3-light-grey w3-round">
            <button class="w3-bar-item w3-button w3-purple" onclick="refreshAllCharts()">
                üîÑ Refresh Charts
            </button>
            <button class="w3-bar-item w3-button" onclick="exportCharts()">
                üì§ Export
            </button>
        </div>
    </div>
    
    <div class="w3-row-padding">
        <!-- Student Distribution -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding chart-card">
                <div class="chart-header">
                    <h4>üë• Student Distribution</h4>
                    <select class="w3-select w3-border w3-round" style="width:150px;" onchange="loadProgramDistribution()" id="programFilter">
                        <option value="all">All Programs</option>
                        <option value="top5">Top 5 Programs</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="programChart"></canvas>
                </div>
                <div class="chart-footer">
                    <div id="programStats" class="stats-summary">
                        Loading statistics...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Room Utilization -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding chart-card">
                <div class="chart-header">
                    <h4>üè´ Room Utilization</h4>
                    <select class="w3-select w3-border w3-round" style="width:150px;" onchange="loadRoomUtilization()" id="roomFilter">
                        <option value="N28">N28 Building</option>
                        <option value="N28A">N28A Building</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="roomChart"></canvas>
                </div>
                <div class="chart-footer">
                    <div id="roomStats" class="stats-summary">
                        Loading room data...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="w3-row-padding w3-margin-top">
        <!-- Course Enrollment -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding chart-card">
                <div class="chart-header">
                    <h4>üìö Top Courses by Enrollment</h4>
                    <select class="w3-select w3-border w3-round" style="width:150px;" onchange="loadCourseEnrollment()" id="courseFilter">
                        <option value="10">Top 10 Courses</option>
                        <option value="5">Top 5 Courses</option>
                        <option value="15">Top 15 Courses</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="courseChart"></canvas>
                </div>
                <div class="chart-footer">
                    <div id="courseStats" class="stats-summary">
                        Loading course data...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Time Slot Distribution -->
        <div class="w3-col m6">
            <div class="w3-card w3-padding chart-card">
                <div class="chart-header">
                    <h4>‚è∞ Time Slot Distribution</h4>
                    <button class="w3-button w3-purple w3-round w3-small" onclick="toggleTimeChart()">
                        Switch View
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
                <div class="chart-footer">
                    <div id="timeStats" class="stats-summary">
                        Loading time data...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Stats -->
    <div class="w3-row-padding w3-margin-top">
        <div class="w3-col m12">
            <div class="w3-card w3-padding">
                <h4>üìà Quick Stats Summary</h4>
                <div class="w3-row" id="summaryStats">
                    <div class="w3-col m3 w3-center">
                        <div class="stat-circle" id="statStudents">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Students</div>
                        </div>
                    </div>
                    <div class="w3-col m3 w3-center">
                        <div class="stat-circle" id="statCourses">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Courses</div>
                        </div>
                    </div>
                    <div class="w3-col m3 w3-center">
                        <div class="stat-circle" id="statRooms">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Rooms</div>
                        </div>
                    </div>
                    <div class="w3-col m3 w3-center">
                        <div class="stat-circle" id="statUtilization">
                            <div class="stat-value">0%</div>
                            <div class="stat-label">Utilization</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<style>
.chart-card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.chart-header h4 {
    margin: 0;
    color: #333;
    font-weight: 600;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.chart-footer {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.stats-summary {
    font-size: 14px;
    color: #666;
    line-height: 1.5;
}

.stat-circle {
    width: 120px;
    height: 120px;
    margin: 0 auto;
    border-radius: 50%;
    background: linear-gradient(135deg, #9c27b0, #2196f3);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
    transition: all 0.3s ease;
}

.stat-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
}

.loading-chart {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
}

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #9c27b0;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script src="../JS/Authenticate.js"></script>
<script src="VisualizationHelper.js"></script>
<script>
$(document).ready(function() {
    // Update date/time
    function updateDateTime() {
        const now = new Date();
        $("#adminDateTime").text(now.toLocaleString());
    }
    updateDateTime();
    setInterval(updateDateTime, 60000);
    
    // Load admin stats
    loadAdminStats();
    
    function loadAdminStats() {
        const adminSessionID = window.parent.adminSessionID;
        const currentSesi = window.parent.currentSesi;
        const currentSemester = window.parent.currentSemester;
        
        if (!adminSessionID) {
            console.warn("Admin session ID not available");
            return;
        }
        
        // Fetch student count
        fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSessionID}&sesi=${currentSesi}&semester=${currentSemester}&limit=5&offset=0`)
            .then(res => res.json())
            .then(students => {
                if (Array.isArray(students)) {
                    $("#totalStudents").text(students.length + "+");
                }
            })
            .catch(err => console.error("Error fetching students:", err));
            
        // Fetch course count
        fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek&sesi=${currentSesi}&semester=${currentSemester}`)
            .then(res => res.json())
            .then(courses => {
                if (Array.isArray(courses)) {
                    $("#totalCourses").text(courses.length);
                    
                    // Calculate total sections
                    const totalSections = courses.reduce((sum, course) => sum + (parseInt(course.bil_seksyen) || 0), 0);
                    $("#totalSections").text(totalSections);
                }
            })
            .catch(err => console.error("Error fetching courses:", err));
            
        // Fetch room count
        fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=ruang&kod_fakulti=fsksm`)
            .then(res => res.json())
            .then(rooms => {
                if (Array.isArray(rooms)) {
                    $("#totalRooms").text(rooms.length);
                    $("#availableRooms").text(Math.floor(rooms.length * 0.7)); // Placeholder
                }
            })
            .catch(err => console.error("Error fetching rooms:", err));
    }
    
    // Load charts after a delay to ensure Google Charts is loaded
    setTimeout(() => {
        if (typeof google !== 'undefined' && google.visualization) {
            loadEnhancedCharts();
        } else {
            console.warn("Google Charts not loaded yet, waiting...");
            setTimeout(loadEnhancedCharts, 1000);
        }
    }, 1000);
});

function loadEnhancedCharts() {
    if (typeof google === 'undefined' || !google.visualization) {
        console.error("Google Charts not available");
        return;
    }
    
    loadProgramDistribution();
    loadRoomHeatmap();
    loadEnrollmentTrends();
    loadTimeSlotDistribution();
}

function loadProgramDistribution() {
    const adminSessionID = window.parent.adminSessionID;
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSessionID}&sesi=${currentSesi}&semester=${currentSemester}&limit=100`)
        .then(res => res.json())
        .then(students => {
            if (!Array.isArray(students)) return;
            
            // Group by program
            const programCounts = {};
            students.forEach(student => {
                const program = student.kod_program || 'Unknown';
                programCounts[program] = (programCounts[program] || 0) + 1;
            });
            
            // Prepare chart data
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Program');
            data.addColumn('number', 'Students');
            
            Object.keys(programCounts).forEach(program => {
                data.addRow([program, programCounts[program]]);
            });
            
            const options = {
                title: 'Student Distribution by Program',
                pieHole: 0.4,
                backgroundColor: '#f5f5f5',
                colors: ['#9c27b0', '#2196f3', '#4caf50', '#ff9800', '#e91e63']
            };
            
            const chart = new google.visualization.PieChart(document.getElementById('programChart'));
            chart.draw(data, options);
        })
        .catch(err => console.error("Error loading program distribution:", err));
}

function loadRoomHeatmap() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${currentSesi}&semester=${currentSemester}&kod_ruang_like=N28&limit=100`)
        .then(res => res.json())
        .then(schedules => {
            if (!Array.isArray(schedules)) return;
            
            // Process room utilization
            const roomUtilization = {};
            schedules.forEach(schedule => {
                const room = schedule.kod_ruang;
                const day = schedule.hari;
                const time = schedule.masa;
                
                if (!roomUtilization[room]) {
                    roomUtilization[room] = {};
                }
                if (!roomUtilization[room][day]) {
                    roomUtilization[room][day] = 0;
                }
                roomUtilization[room][day]++;
            });
            
            // Prepare heatmap data
            const rooms = Object.keys(roomUtilization).slice(0, 10); // Top 10 rooms
            const days = [2, 3, 4, 5, 6]; // Monday to Friday
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Room');
            days.forEach(day => {
                const dayName = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][day-2];
                data.addColumn('number', dayName);
            });
            
            rooms.forEach(room => {
                const row = [room];
                days.forEach(day => {
                    row.push(roomUtilization[room][day] || 0);
                });
                data.addRow(row);
            });
            
            const options = {
                title: 'Room Utilization (Classes per Day)',
                hAxis: { title: 'Day of Week' },
                vAxis: { title: 'Room' },
                colors: ['#e0f2f1', '#80cbc4', '#26a69a', '#00897b', '#00695c']
            };
            
            const chart = new google.visualization.BarChart(document.getElementById('roomHeatmap'));
            chart.draw(data, options);
        })
        .catch(err => console.error("Error loading room heatmap:", err));
}

function loadEnrollmentTrends() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek&sesi=${currentSesi}&semester=${currentSemester}`)
        .then(res => res.json())
        .then(courses => {
            if (!Array.isArray(courses)) return;
            
            // Sort by enrollment and take top 10
            const sortedCourses = courses
                .sort((a, b) => (b.bil_pelajar || 0) - (a.bil_pelajar || 0))
                .slice(0, 10);
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Course');
            data.addColumn('number', 'Enrollment');
            data.addColumn('number', 'Sections');
            
            sortedCourses.forEach(course => {
                data.addRow([
                    course.kod_subjek,
                    parseInt(course.bil_pelajar) || 0,
                    parseInt(course.bil_seksyen) || 0
                ]);
            });
            
            const options = {
                title: 'Top 10 Courses by Enrollment',
                hAxis: { title: 'Course Code' },
                vAxis: { title: 'Number of Students' },
                seriesType: 'bars',
                series: { 1: { type: 'line' } },
                colors: ['#2196f3', '#4caf50']
            };
            
            const chart = new google.visualization.ComboChart(document.getElementById('enrollmentChart'));
            chart.draw(data, options);
        })
        .catch(err => console.error("Error loading enrollment trends:", err));
}

function loadTimeSlotDistribution() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${currentSesi}&semester=${currentSemester}&limit=200`)
        .then(res => res.json())
        .then(schedules => {
            if (!Array.isArray(schedules)) return;
            
            // Count classes by time slot
            const timeSlots = {
                1: '8:00-9:00',
                2: '9:00-10:00',
                3: '10:00-11:00',
                4: '11:00-12:00',
                5: '12:00-13:00',
                7: '14:00-15:00',
                8: '15:00-16:00',
                9: '16:00-17:00',
                10: '17:00-18:00'
            };
            
            const slotCounts = {};
            schedules.forEach(schedule => {
                const slot = schedule.masa;
                slotCounts[slot] = (slotCounts[slot] || 0) + 1;
            });
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Time Slot');
            data.addColumn('number', 'Number of Classes');
            
            Object.keys(timeSlots).forEach(slot => {
                if (slotCounts[slot]) {
                    data.addRow([timeSlots[slot], slotCounts[slot]]);
                }
            });
            
            const options = {
                title: 'Class Distribution by Time Slot',
                hAxis: { title: 'Time' },
                vAxis: { title: 'Classes' },
                colors: ['#ff9800']
            };
            
            const chart = new google.visualization.ColumnChart(document.getElementById('timeSlotChart'));
            chart.draw(data, options);
        })
        .catch(err => console.error("Error loading time slot distribution:", err));
}
let programChart, roomChart, courseChart, timeChart;
let timeChartType = 'bar';

$(document).ready(function() {
    // Load all charts
    setTimeout(() => {
        loadProgramDistribution();
        loadRoomUtilization();
        loadCourseEnrollment();
        loadTimeDistribution();
        loadSummaryStats();
    }, 500);
});

async function loadProgramDistribution() {
    const adminSessionID = window.parent.adminSessionID;
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    $('#programStats').html('<div class="loading-spinner"></div><div>Loading program data...</div>');
    
    try {
        const students = await VisualizationHelper.fetchTTMSData('pelajar', {
            session_id: adminSessionID,
            sesi: currentSesi,
            semester: currentSemester,
            limit: 200
        });
        
        if (students.length === 0) {
            $('#programStats').html('No student data available');
            return;
        }
        
        // Group by program
        const programCounts = {};
        students.forEach(student => {
            const program = student.kod_program || 'Unknown Program';
            programCounts[program] = (programCounts[program] || 0) + 1;
        });
        
        // Sort and filter
        const filter = $('#programFilter').val();
        let programs = Object.entries(programCounts)
            .sort((a, b) => b[1] - a[1]);
            
        if (filter === 'top5') {
            programs = programs.slice(0, 5);
        }
        
        const labels = programs.map(([program]) => program.substring(0, 20) + (program.length > 20 ? '...' : ''));
        const data = programs.map(([, count]) => count);
        
        // Create doughnut chart
        if (programChart) programChart.destroy();
        
        programChart = VisualizationHelper.createDoughnutChart('programChart', labels, data, 'Student Distribution');
        
        // Update stats
        const total = data.reduce((a, b) => a + b, 0);
        const topProgram = programs[0];
        $('#programStats').html(`
            <strong>Total Students:</strong> ${VisualizationHelper.formatNumber(total)}<br>
            <strong>Top Program:</strong> ${topProgram[0]} (${topProgram[1]} students)<br>
            <strong>Programs Count:</strong> ${programs.length}
        `);
        
        // Update summary stat
        $('#statStudents .stat-value').text(VisualizationHelper.formatNumber(total));
        
    } catch (error) {
        $('#programStats').html(`Error: ${error.message}`);
        console.error('Error loading program distribution:', error);
    }
}

async function loadRoomUtilization() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    const building = $('#roomFilter').val();
    
    $('#roomStats').html('<div class="loading-spinner"></div><div>Loading room data...</div>');
    
    try {
        const schedules = await VisualizationHelper.fetchTTMSData('jadual_ruang', {
            sesi: currentSesi,
            semester: currentSemester,
            kod_ruang_like: building,
            limit: 500
        });
        
        if (schedules.length === 0) {
            $('#roomStats').html('No schedule data available');
            return;
        }
        
        // Group by room
        const roomUsage = {};
        schedules.forEach(schedule => {
            const room = schedule.kod_ruang || 'Unknown Room';
            roomUsage[room] = (roomUsage[room] || 0) + 1;
        });
        
        // Get top 10 rooms
        const rooms = Object.entries(roomUsage)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        const labels = rooms.map(([room]) => room);
        const data = rooms.map(([, count]) => count);
        
        // Create gradient colors
        const canvas = document.getElementById('roomChart');
        const ctx = canvas.getContext('2d');
        const gradient = VisualizationHelper.createGradient(ctx, 'rgba(33, 150, 243, 0.8)', 'rgba(33, 150, 243, 0.2)');
        
        // Create bar chart
        if (roomChart) roomChart.destroy();
        
        roomChart = VisualizationHelper.createBarChart('roomChart', labels, [{
            label: 'Classes per Week',
            data: data,
            backgroundColor: gradient,
            borderColor: '#2196f3'
        }], `${building} Building - Room Utilization`);
        
        // Update stats
        const totalRooms = Object.keys(roomUsage).length;
        const avgUtilization = Math.round(data.reduce((a, b) => a + b, 0) / totalRooms);
        const mostUsed = rooms[0];
        
        $('#roomStats').html(`
            <strong>Total Rooms Used:</strong> ${totalRooms}<br>
            <strong>Most Active Room:</strong> ${mostUsed[0]} (${mostUsed[1]} classes)<br>
            <strong>Average Usage:</strong> ${avgUtilization} classes/week
        `);
        
        // Update summary stat
        $('#statRooms .stat-value').text(totalRooms);
        
    } catch (error) {
        $('#roomStats').html(`Error: ${error.message}`);
        console.error('Error loading room utilization:', error);
    }
}

async function loadCourseEnrollment() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    const limit = parseInt($('#courseFilter').val());
    
    $('#courseStats').html('<div class="loading-spinner"></div><div>Loading course data...</div>');
    
    try {
        const courses = await VisualizationHelper.fetchTTMSData('subjek', {
            sesi: currentSesi,
            semester: currentSemester
        });
        
        if (courses.length === 0) {
            $('#courseStats').html('No course data available');
            return;
        }
        
        // Get top courses by enrollment
        const topCourses = courses
            .filter(course => course.bil_pelajar && course.kod_subjek)
            .sort((a, b) => (parseInt(b.bil_pelajar) || 0) - (parseInt(a.bil_pelajar) || 0))
            .slice(0, limit);
        
        const labels = topCourses.map(course => course.kod_subjek.substring(0, 15) + (course.kod_subjek.length > 15 ? '...' : ''));
        const enrollment = topCourses.map(course => parseInt(course.bil_pelajar) || 0);
        const sections = topCourses.map(course => parseInt(course.bil_seksyen) || 0);
        
        // Create mixed chart
        if (courseChart) courseChart.destroy();
        
        const canvas = document.getElementById('courseChart');
        const ctx = canvas.getContext('2d');
        
        courseChart = VisualizationHelper.createChart('courseChart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Enrollment',
                        data: enrollment,
                        backgroundColor: VisualizationHelper.createGradient(ctx, 'rgba(76, 175, 80, 0.8)', 'rgba(76, 175, 80, 0.2)'),
                        borderColor: '#4caf50',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Sections',
                        data: sections,
                        type: 'line',
                        borderColor: '#ff9800',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        tension: 0.2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Enrollment'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Sections'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Top Courses by Enrollment',
                        font: { size: 16, weight: 'bold' }
                    }
                }
            }
        });
        
        // Update stats
        const totalEnrollment = enrollment.reduce((a, b) => a + b, 0);
        const avgSections = (sections.reduce((a, b) => a + b, 0) / sections.length).toFixed(1);
        const topCourse = topCourses[0];
        
        $('#courseStats').html(`
            <strong>Total Enrollment:</strong> ${VisualizationHelper.formatNumber(totalEnrollment)}<br>
            <strong>Top Course:</strong> ${topCourse.kod_subjek} (${topCourse.bil_pelajar} students)<br>
            <strong>Avg Sections:</strong> ${avgSections} per course
        `);
        
        // Update summary stat
        $('#statCourses .stat-value').text(courses.length);
        
    } catch (error) {
        $('#courseStats').html(`Error: ${error.message}`);
        console.error('Error loading course enrollment:', error);
    }
}

async function loadTimeDistribution() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    $('#timeStats').html('<div class="loading-spinner"></div><div>Loading time data...</div>');
    
    try {
        const schedules = await VisualizationHelper.fetchTTMSData('jadual_ruang', {
            sesi: currentSesi,
            semester: currentSemester,
            limit: 300
        });
        
        if (schedules.length === 0) {
            $('#timeStats').html('No schedule data available');
            return;
        }
        
        // Map time slots to readable format
        const timeSlots = {
            1: '8-9 AM', 2: '9-10 AM', 3: '10-11 AM', 4: '11-12 PM',
            5: '12-1 PM', 7: '2-3 PM', 8: '3-4 PM', 9: '4-5 PM', 10: '5-6 PM'
        };
        
        // Count classes by time slot
        const slotCounts = {};
        Object.keys(timeSlots).forEach(slot => {
            slotCounts[slot] = 0;
        });
        
        schedules.forEach(schedule => {
            const slot = schedule.masa;
            if (slotCounts[slot] !== undefined) {
                slotCounts[slot]++;
            }
        });
        
        const labels = Object.values(timeSlots);
        const data = Object.keys(timeSlots).map(slot => slotCounts[slot] || 0);
        
        // Create chart based on current type
        if (timeChart) timeChart.destroy();
        
        if (timeChartType === 'bar') {
            const canvas = document.getElementById('timeChart');
            const ctx = canvas.getContext('2d');
            
            timeChart = VisualizationHelper.createBarChart('timeChart', labels, [{
                label: 'Number of Classes',
                data: data,
                backgroundColor: VisualizationHelper.createGradient(ctx, 'rgba(255, 152, 0, 0.8)', 'rgba(255, 152, 0, 0.2)'),
                borderColor: '#ff9800'
            }], 'Class Distribution by Time Slot');
        } else {
            timeChart = VisualizationHelper.createLineChart('timeChart', labels, [{
                label: 'Class Frequency',
                data: data,
                borderColor: '#ff9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                fill: true
            }], 'Class Distribution by Time Slot');
        }
        
        // Update stats
        const peakSlot = Object.keys(timeSlots).reduce((a, b) => slotCounts[a] > slotCounts[b] ? a : b);
        const peakCount = slotCounts[peakSlot];
        const totalClasses = data.reduce((a, b) => a + b, 0);
        
        $('#timeStats').html(`
            <strong>Peak Hour:</strong> ${timeSlots[peakSlot]} (${peakCount} classes)<br>
            <strong>Total Classes:</strong> ${totalClasses}<br>
            <strong>Avg per Slot:</strong> ${Math.round(totalClasses / labels.length)}
        `);
        
    } catch (error) {
        $('#timeStats').html(`Error: ${error.message}`);
        console.error('Error loading time distribution:', error);
    }
}

function toggleTimeChart() {
    timeChartType = timeChartType === 'bar' ? 'line' : 'bar';
    loadTimeDistribution();
}

async function loadSummaryStats() {
    try {
        const currentSesi = window.parent.currentSesi;
        const currentSemester = window.parent.currentSemester;
        const adminSessionID = window.parent.adminSessionID;
        
        // Fetch all data in parallel
        const [students, courses, rooms, schedules] = await Promise.all([
            VisualizationHelper.fetchTTMSData('pelajar', {
                session_id: adminSessionID,
                sesi: currentSesi,
                semester: currentSemester,
                limit: 50
            }),
            VisualizationHelper.fetchTTMSData('subjek', {
                sesi: currentSesi,
                semester: currentSemester
            }),
            VisualizationHelper.fetchTTMSData('ruang', {
                kod_fakulti: 'fsksm'
            }),
            VisualizationHelper.fetchTTMSData('jadual_ruang', {
                sesi: currentSesi,
                semester: currentSemester,
                limit: 100
            })
        ]);
        
        // Calculate utilization (simplified)
        const totalTimeSlots = 45; // 5 days * 9 time slots
        const usedSlots = schedules.length;
        const utilization = Math.round((usedSlots / totalTimeSlots) * 100);
        
        // Update all stats
        $('#statStudents .stat-value').text(students.length);
        $('#statCourses .stat-value').text(courses.length);
        $('#statRooms .stat-value').text(rooms.length);
        $('#statUtilization .stat-value').text(utilization + '%');
        
    } catch (error) {
        console.error('Error loading summary stats:', error);
    }
}

function refreshAllCharts() {
    $('.stat-value').text('...');
    loadProgramDistribution();
    loadRoomUtilization();
    loadCourseEnrollment();
    loadTimeDistribution();
    loadSummaryStats();
}

function exportCharts() {
    alert('Chart export functionality would be implemented here.\n\nFeatures:\n‚Ä¢ Export as PNG/JPEG\n‚Ä¢ Export as PDF report\n‚Ä¢ Export as CSV data\n‚Ä¢ Share via email');
}
</script>