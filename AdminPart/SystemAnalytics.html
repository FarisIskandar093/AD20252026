<div class="w3-container">
    <h2 class="w3-text-purple">ğŸ“ˆ System Analytics</h2>
    <p class="w3-text-grey">System performance and usage statistics</p>
    
    <div class="w3-row-padding w3-margin-bottom">
        <div class="w3-col m4">
            <div class="w3-card w3-padding w3-center">
                <div class="w3-xxlarge w3-text-purple">ğŸ“Š</div>
                <h4>Data Volume</h4>
                <p>Total records in system</p>
                <h2 id="dataVolume">0</h2>
            </div>
        </div>
        <div class="w3-col m4">
            <div class="w3-card w3-padding w3-center">
                <div class="w3-xxlarge w3-text-blue">ğŸ‘¥</div>
                <h4>Active Users</h4>
                <p>Last 24 hours</p>
                <h2 id="activeUsers">0</h2>
            </div>
        </div>
        <div class="w3-col m4">
            <div class="w3-card w3-padding w3-center">
                <div class="w3-xxlarge w3-text-green">ğŸ«</div>
                <h4>Room Utilization</h4>
                <p>Average this week</p>
                <h2 id="roomUtil">0%</h2>
            </div>
        </div>
    </div>
    
    <div class="w3-row">
        <div class="w3-col m8">
            <div class="w3-card w3-padding">
                <h4>ğŸ“ˆ Usage Trends</h4>
                <div id="usageChart" style="width:100%; height:400px;"></div>
            </div>
        </div>
        
        <div class="w3-col m4">
            <div class="w3-card w3-padding">
                <h4>ğŸ”” System Health</h4>
                
                <div class="w3-panel w3-green w3-round">
                    <h5>âœ… System Status</h5>
                    <p>All systems operational</p>
                </div>
                
                <div class="w3-panel w3-blue w3-round">
                    <h5>ğŸ“… Last Updated</h5>
                    <p id="lastUpdated">Just now</p>
                </div>
                
                <div class="w3-panel w3-yellow w3-round">
                    <h5>âš ï¸ Pending Actions</h5>
                    <p>0 pending approvals</p>
                </div>
                
                <div class="w3-margin-top">
                    <button class="w3-button w3-purple w3-block" onclick="refreshAnalytics()">
                        ğŸ”„ Refresh Analytics
                    </button>
                </div>
                
                <div class="w3-margin-top">
                    <button class="w3-button w3-blue w3-block" onclick="exportAnalytics()">
                        ğŸ“¤ Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="w3-row-padding w3-margin-top">
    <div class="w3-col m6">
        <div class="w3-card w3-padding">
            <h4>ğŸ“š Course Complexity Analysis</h4>
            <div id="courseComplexityChart" style="width:100%; height:300px;"></div>
        </div>
    </div>
    
    <div class="w3-col m6">
        <div class="w3-card w3-padding">
            <h4>ğŸ‘¨â€ğŸ« Lecturer Workload</h4>
            <div id="lecturerWorkloadChart" style="width:100%; height:300px;"></div>
        </div>
    </div>
</div>

<div class="w3-row-padding w3-margin-top">
    <div class="w3-col m12">
        <div class="w3-card w3-padding">
            <h4>ğŸ“… Weekly Schedule Density</h4>
            <div id="weeklyDensityChart" style="width:100%; height:400px;"></div>
        </div>
    </div>
</div>
    
    <div class="w3-card w3-padding w3-margin-top">
        <h4>ğŸ“‹ Recent System Events</h4>
        <table class="w3-table-all w3-hoverable">
            <thead>
                <tr class="w3-light-grey">
                    <th>Time</th>
                    <th>Event</th>
                    <th>User</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="systemEvents">
                <tr>
                    <td>Just now</td>
                    <td><span class="w3-tag w3-blue">INFO</span></td>
                    <td>System</td>
                    <td>Analytics dashboard loaded</td>
                </tr>
                <tr>
                    <td>5 min ago</td>
                    <td><span class="w3-tag w3-green">LOGIN</span></td>
                    <td>Admin</td>
                    <td>User logged into admin panel</td>
                </tr>
                <tr>
                    <td>1 hour ago</td>
                    <td><span class="w3-tag w3-blue">DATA</span></td>
                    <td>System</td>
                    <td>Daily data sync completed</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script src="../JS/Authenticate.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    google.charts.load('current', {'packages':['line']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
        // Sample data for usage chart
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Day');
        data.addColumn('number', 'User Logins');
        data.addColumn('number', 'Data Requests');
        data.addColumn('number', 'API Calls');
        
        data.addRows([
            ['Mon', 120, 450, 850],
            ['Tue', 135, 480, 920],
            ['Wed', 150, 520, 980],
            ['Thu', 145, 510, 950],
            ['Fri', 130, 490, 900],
            ['Sat', 80, 300, 600],
            ['Sun', 60, 250, 500]
        ]);
        
        var options = {
            title: 'Weekly System Usage',
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#9c27b0', '#2196f3', '#4caf50']
        };
        
        var chart = new google.visualization.LineChart(document.getElementById('usageChart'));
        chart.draw(data, options);
        
        // Update stats
        updateAnalyticsStats();
    }

    function updateAnalyticsStats() {
        // Simulate loading data
        $("#dataVolume").text("15,240");
        $("#activeUsers").text("42");
        $("#roomUtil").text("68%");
        $("#lastUpdated").text(new Date().toLocaleTimeString());
    }

    function refreshAnalytics() {
        $("#dataVolume").text("...");
        $("#activeUsers").text("...");
        $("#roomUtil").text("...");
        
        setTimeout(() => {
            updateAnalyticsStats();
            drawCharts();
            alert("Analytics refreshed successfully!");
        }, 1000);
    }

    function exportAnalytics() {
        const date = new Date().toISOString().split('T')[0];
        alert(`Exporting analytics report for ${date}\n\nReport would be downloaded as CSV/PDF in a real system.`);
    }

    $(document).ready(function() {
        // Load initial data
        setTimeout(updateAnalyticsStats, 500);
    });
</script>
<script>
// Add these chart functions to SystemAnalytics.html script

function loadCourseComplexity() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek&sesi=${currentSesi}&semester=${currentSemester}`)
        .then(res => res.json())
        .then(courses => {
            if (!Array.isArray(courses)) return;
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Course');
            data.addColumn('number', 'Students');
            data.addColumn('number', 'Sections');
            data.addColumn('number', 'Credit Hours');
            
            courses.slice(0, 15).forEach(course => {
                data.addRow([
                    course.kod_subjam || course.kod_subjek,
                    parseInt(course.bil_pelajar) || 0,
                    parseInt(course.bil_seksyen) || 0,
                    parseInt(course.jam_kredit) || 0
                ]);
            });
            
            const options = {
                title: 'Course Complexity Analysis',
                hAxis: { title: 'Course' },
                vAxis: { title: 'Count' },
                seriesType: 'bars',
                series: {
                    0: { targetAxisIndex: 0 },
                    1: { targetAxisIndex: 0, type: 'line' },
                    2: { targetAxisIndex: 1, type: 'line' }
                },
                vAxes: {
                    0: { title: 'Students/Sections' },
                    1: { title: 'Credit Hours' }
                },
                colors: ['#9c27b0', '#2196f3', '#4caf50']
            };
            
            const chart = new google.visualization.ComboChart(document.getElementById('courseComplexityChart'));
            chart.draw(data, options);
        });
}

function loadLecturerWorkload() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    // Fetch lecturer schedules
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_pensyarah&sesi=${currentSesi}&semester=${currentSemester}&limit=100`)
        .then(res => res.json())
        .then(schedules => {
            if (!Array.isArray(schedules)) return;
            
            // Count classes per lecturer
            const lecturerWorkload = {};
            schedules.forEach(schedule => {
                const lecturer = schedule.pensyarah;
                if (lecturer && lecturer.nama_pensyarah) {
                    const name = lecturer.nama_pensyarah;
                    lecturerWorkload[name] = (lecturerWorkload[name] || 0) + 1;
                }
            });
            
            // Sort and take top 10
            const sorted = Object.entries(lecturerWorkload)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Lecturer');
            data.addColumn('number', 'Classes');
            
            sorted.forEach(([name, count]) => {
                data.addRow([name.split(' ')[0], count]); // Use first name only
            });
            
            const options = {
                title: 'Top 10 Lecturers by Class Count',
                hAxis: { title: 'Lecturer' },
                vAxis: { title: 'Number of Classes' },
                colors: ['#2196f3'],
                legend: { position: 'none' }
            };
            
            const chart = new google.visualization.ColumnChart(document.getElementById('lecturerWorkloadChart'));
            chart.draw(data, options);
        });
}

function loadWeeklyScheduleDensity() {
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;
    
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${currentSesi}&semester=${currentSemester}&limit=500`)
        .then(res => res.json())
        .then(schedules => {
            if (!Array.isArray(schedules)) return;
            
            // Create matrix: days (2-6) x time slots (1-10)
            const density = {};
            for (let day = 2; day <= 6; day++) {
                density[day] = {};
                for (let slot = 1; slot <= 10; slot++) {
                    if (slot !== 6) density[day][slot] = 0; // Skip slot 6 (lunch)
                }
            }
            
            // Count classes
            schedules.forEach(schedule => {
                const day = schedule.hari;
                const slot = schedule.masa;
                if (density[day] && density[day][slot] !== undefined) {
                    density[day][slot]++;
                }
            });
            
            // Prepare data for heatmap
            const timeSlots = {
                1: '8-9', 2: '9-10', 3: '10-11', 4: '11-12', 5: '12-13',
                7: '14-15', 8: '15-16', 9: '16-17', 10: '17-18'
            };
            
            const days = {2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu', 6: 'Fri'};
            
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Time');
            
            Object.keys(days).forEach(day => {
                data.addColumn('number', days[day]);
            });
            
            Object.keys(timeSlots).forEach(slot => {
                const row = [timeSlots[slot]];
                Object.keys(days).forEach(day => {
                    row.push(density[day][slot] || 0);
                });
                data.addRow(row);
            });
            
            const options = {
                title: 'Weekly Class Density Heatmap',
                hAxis: { title: 'Day' },
                vAxis: { title: 'Time Slot' },
                heatmap: {
                    colorAxis: {
                        colors: ['#e0f7fa', '#80deea', '#26c6da', '#00acc1', '#00838f']
                    }
                }
            };
            
            const chart = new google.visualization.HeatMap(document.getElementById('weeklyDensityChart'));
            chart.draw(data, options);
        });
}

// Update the existing google.charts.setOnLoadCallback to include new charts
google.charts.setOnLoadCallback(function() {
    drawCharts(); // Existing function
    loadCourseComplexity();
    loadLecturerWorkload();
    loadWeeklyScheduleDensity();
});

// Update refreshAnalytics function to reload all charts
function refreshAnalytics() {
    drawCharts();
    loadCourseComplexity();
    loadLecturerWorkload();
    loadWeeklyScheduleDensity();
    updateAnalyticsStats();
    alert("All charts refreshed!");
}
</script>