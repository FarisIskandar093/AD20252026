<!DOCTYPE html>
<html>
<head>
    <title>Detailed Room Usage Analysis - FSKSM N28/N28A</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Optional style for sticky header on large tables */
        #roomListTable th {
            background-color: #3f51b5; 
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .w3-table-all {
            table-layout: fixed; 
            width: 100%;
        }
        /* Define column widths */
        #roomListTable th:nth-child(1) { width: 5%; } 
        #roomListTable th:nth-child(2) { width: 10%; } 
        #roomListTable th:nth-child(3) { width: 20%; } 
        #roomListTable th:nth-child(4) { width: 12%; } 
        #roomListTable th:nth-child(5) { width: 8%; } 
        #roomListTable th:nth-child(6) { width: 8%; } 
        #roomListTable th:nth-child(7) { width: 8%; } 
        /* Usage columns */
        #roomListTable th:nth-child(8) { width: 14%; } 
        #roomListTable th:nth-child(9) { width: 15%; } 
    </style>
</head>

<body class="w3-container">

<h2 class="w3-center w3-text-blue">Detailed Room Usage Analysis (FSKSM N28/N28A)</h2>

<div class="w3-panel w3-border w3-light-grey w3-round-large w3-padding-16 w3-margin-bottom">
    <p>
        <strong>Session/Semester:</strong> <span id="sessionSem">Loading...</span> 
        <span class="w3-right w3-tag w3-blue-grey w3-round" id="roomCount">0 Rooms Loaded</span>
    </p>
</div>

<div class="loading w3-margin-top" id="loadingMsg">
    ðŸ”„ Fetching FSKSM rooms...
</div>

<div id="chart_div" style="width: 100%; height: 500px;"></div>
<hr>

<div style="overflow-x: auto;">
    <table class="w3-table-all w3-hoverable w3-card-4" id="roomListTable" style="display:none; min-width: 900px;">
        <thead>
            <tr class="w3-blue-grey">
                <th>No.</th>
                <th>Room Code</th>
                <th>Room Name</th>
                <th>Abbreviated Name</th>
                <th>Faculty</th>
                <th>Type</th>
                <th>Capacity</th>
                <th colspan="2" class="w3-center">Usage</th>
            </tr>
            <tr class="w3-light-grey w3-small">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>Time/Week (Hrs)</th>
                <th>Number of Subject</th>
            </tr>
        </thead>
        <tbody id="roomListBody">
            </tbody>
    </table>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
$(document).ready(function() {

    // --- CONSTANTS ---
    const BASE_API_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
    const ROOM_LIST_API_URL_FSKSM = BASE_API_URL + "ruang&kod_fakulti=fsksm";
    const JADUAL_RUANG_ENTITY = "jadual_ruang";
    
    // --- SESSION CONTEXT ---
    let currentSesi = null;
    let currentSemester = null;
    
    // Attempt to get context from parent window (for embedded mode)
    try {
        currentSesi = window.parent.currentSesi;
        currentSemester = window.parent.currentSemester;
    } catch (e) {
        console.warn("Could not access parent window variables. Assuming default context.");
    }
    
    // Provide default values to prevent the 'Critical context is missing' error
    if (!currentSesi || !currentSemester) {
        currentSesi = "2025/2026"; 
        currentSemester = "1";
        console.warn(`[DIAGNOSTICS] Using default Session: ${currentSesi} and Semester: ${currentSemester} for standalone execution.`);
        $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester} (Default Context Used)`);
    } else {
        $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
    }
    
    // Exit if essential context is still truly missing/invalid
    if (!currentSesi || !currentSemester) {
        $("#loadingMsg").html("âŒ Critical Session/Semester context is missing.");
        return;
    }
    
    // FIX APPLIED HERE: Load the chart package and wrap the entire execution inside the callback.
    // This ensures Google Charts is fully ready before execution proceeds, resolving the fatal error.
    google.charts.load('current', {'packages':['bar']});
    google.charts.setOnLoadCallback(fetchAndAnalyzeRooms);
    
    
    // =================================================================
    // MASTER CONTROL FUNCTION (CALLED BY CHART LOADER)
    // =================================================================

    function fetchAndAnalyzeRooms() {
        // 1. Fetch FSKSM rooms
        fetch(ROOM_LIST_API_URL_FSKSM)
            .then(res => res.json())
            .then(rooms => {
                if (!Array.isArray(rooms) || rooms.length === 0) {
                     $("#loadingMsg").html("âš ï¸ API returned no room data for FSKSM.");
                     return;
                }
                
                // 2. Client-side Filter for N28/N28A blocks
                const filteredRooms = rooms.filter(room => {
                    const code = room.kod_ruang;
                    return code && (code.startsWith('N28') || code.startsWith('N28A'));
                });

                if (filteredRooms.length === 0) {
                     $("#loadingMsg").html(`âš ï¸ Found ${rooms.length} FSKSM rooms, but 0 matched N28/N28A prefix.`);
                     return;
                }

                $("#loadingMsg").text(`â³ Found ${filteredRooms.length} N28/N28A rooms. Calculating usage...`);
                $("#roomCount").text(`${filteredRooms.length} Rooms Found`);
                
                // 3. Fetch usage for the filtered rooms concurrently
                return analyzeRoomUsage(filteredRooms);
            })
            .then(analyzedRooms => {
                // 4. Display the final table
                displayRoomList(analyzedRooms);
                
                // 5. Draw the usage chart (Chart library is now guaranteed to be loaded)
                drawRoomUsageChart(analyzedRooms);

                $("#loadingMsg").hide();
                $("#roomListTable").show();
                $("#roomCount").text(`${analyzedRooms.length} N28/N28A Rooms Displayed`);
            })
            .catch(err => {
                console.error("âŒ Fatal Error during analysis:", err);
                $("#loadingMsg").html(`âŒ Fatal Error: ${err.message}. Check browser console for details.`);
            });
    }

    // =================================================================
    // USAGE CALCULATION LOGIC (RETAINED CORRECT LOGIC)
    // =================================================================

    function fetchRoomSchedule(room) {
        const url = `${BASE_API_URL}${JADUAL_RUANG_ENTITY}&sesi=${currentSesi}&semester=${currentSemester}&kod_ruang=${room.kod_ruang}`;

        return fetch(url)
            .then(res => res.json())
            .then(schedule => {
                if (!Array.isArray(schedule)) {
                    return calculateUsage(room, []); 
                }
                return calculateUsage(room, schedule);
            })
            .catch(error => {
                console.error(`âŒ SCHEDULE FETCH ERROR for ${room.kod_ruang}:`, error);
                return { 
                    ...room, 
                    usageHours: 0, 
                    subjectCount: 0 
                };
            });
    }

    function calculateUsage(room, schedule) {
        const uniqueWeeklySlots = new Set();
        const uniqueSubjects = new Set();
        
        schedule.forEach(slot => {
            // Safer way to access nested properties: slot.subjek.kod_subjek
            const kodSubjek = slot.subjek && slot.subjek.kod_subjek;
            const sekyen = (slot.subjek && slot.subjek.seksyen) || '0';
            const hari = slot.hari;
            const masa = slot.masa;
            
            // 1. COUNT UNIQUE SUBJECTS (Number of Subject: kod_subjek only)
            if (kodSubjek) {
                // Counts only unique subject codes (e.g., SECI1013)
                uniqueSubjects.add(kodSubjek); 
            }

            // 2. COUNT USAGE HOURS (Time/Week: unique weekly slots)
            if (hari && masa && room.kod_ruang) {
                let uniqueSlotKey;
                
                // Key combines Subject, Section, Day, and Time for unique weekly slot count (e.g., 42, 31, 28)
                if (kodSubjek) {
                    uniqueSlotKey = `${kodSubjek}-${sekyen}-${hari}-${masa}`;
                } else {
                    // Key for non-subject bookings
                    uniqueSlotKey = `NON_SUB_BOOKING-${room.kod_ruang}-${hari}-${masa}`;
                }
                
                uniqueWeeklySlots.add(uniqueSlotKey);
            }
        });
        
        // The usageHours is the size of the set of unique weekly time slots.
        const usageHours = uniqueWeeklySlots.size; 
        const subjectCount = uniqueSubjects.size;

        if (usageHours > 0) {
            console.log(`[SUCCESS] Room: ${room.kod_ruang} calculated usage: ${usageHours} Hrs / ${subjectCount} Subjects.`);
        }

        return {
            ...room,
            usageHours: usageHours, 
            subjectCount: subjectCount
        };
    }

    function analyzeRoomUsage(rooms) {
        const promises = rooms.map(room => fetchRoomSchedule(room));
        return Promise.allSettled(promises)
            .then(results => {
                return results
                    .filter(result => result.status === 'fulfilled')
                    .map(result => result.value);
            });
    }

    // =================================================================
    // CHARTING LOGIC
    // =================================================================

    function drawRoomUsageChart(rooms) {
        // 1. Sort and select Top 10 by usageHours
        const top10Rooms = rooms
            .filter(room => room.usageHours > 0) // Only chart rooms with usage
            .sort((a, b) => b.usageHours - a.usageHours)
            .slice(0, 10);
            
        if (top10Rooms.length < 2) {
            $("#chart_div").html('<div class="w3-panel w3-yellow w3-padding">Not enough usage data found to plot a meaningful chart (need at least 2 rooms).</div>');
            return;
        }

        // 2. Prepare Google Chart DataTable
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Room');
        data.addColumn('number', 'Time/Week (Hrs)');
        
        // Map the room data to the required array format for the chart
        var chartData = top10Rooms.map(room => {
            const roomLabel = room.nama_ruang_singkatan || room.kod_ruang;
            return [roomLabel, room.usageHours];
        });
        
        data.addRows(chartData);

        // 3. Define Chart Options
        var options = {
            title: `Top ${top10Rooms.length} N28/N28A Room Usage: Time/Week (Hrs)`,
            hAxis: {
                title: 'Time/Week (Hours)',
                minValue: 0
            },
            vAxis: {
                title: 'Room Code / Abbreviated Name'
            },
            bars: 'horizontal', 
            chartArea: { width: '60%' } 
        };

        // 4. Draw the Chart
        var chart = new google.charts.Bar(document.getElementById('chart_div'));
        chart.draw(data, google.charts.Bar.convertOptions(options));
    }

    // =================================================================
    // DISPLAY LOGIC
    // =================================================================

    function displayRoomList(rooms) {
        const body = $("#roomListBody");
        body.empty();
        
        // Sort in descending order of usage hours
        rooms.sort((a, b) => b.usageHours - a.usageHours);

        rooms.forEach((room, index) => {
            const usageTagColor = room.usageHours > 0 ? 'w3-teal' : 'w3-light-grey w3-text-dark-grey';
            const subjectTagColor = room.subjectCount > 0 ? 'w3-indigo' : 'w3-light-grey w3-text-dark-grey';
            
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${room.kod_ruang || 'N/A'}</strong></td>
                    <td>${room.nama_ruang || 'N/A'}</td>
                    <td>${room.nama_ruang_singkatan || 'N/A'}</td>
                    <td>${room.kod_fakulti || 'N/A'}</td>
                    <td>${room.jenis || 'N/A'}</td> 
                    <td class="w3-center">${room.kapasiti || 'N/A'}</td> 
                    <td class="w3-center">
                        <span class="w3-tag ${usageTagColor} w3-round">${room.usageHours}</span>
                    </td>
                    <td class="w3-center">
                        <span class="w3-tag ${subjectTagColor} w3-round">${room.subjectCount}</span>
                    </td>
                </tr>
            `;
            body.append(row);
        });
    }
});
</script>
</body>
</html>