<!-- SubjectSection.html - Content to be loaded inside Main.html -->
<link rel="stylesheet" href="Styles/SubjectStyle.css">

<div class="subject-sections-container">
  <!-- Page Header -->
  <div class="page-header">
    <h3>
      <span class="header-icon">ğŸ“š</span>
      Subject Sections â€“ With Class Schedule (Lecturer View)
    </h3>
    <p class="subtitle">Explore all available course sections and their schedules</p>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="sessionSelect">ğŸ—“ï¸ Session</label>
      <select id="sessionSelect">
        <option value="">Loading...</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="semesterSelect">ğŸ“… Semester</label>
      <select id="semesterSelect">
        <option value="">Select session first</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="lecturerFilter">ğŸ‘¨â€ğŸ« Filter Lecturer:</label>
      <select id="lecturerFilter">
        <option value="">All Lecturers</option>
      </select>
    </div>
  </div>

  <!-- Search -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="ğŸ” Search by course code or subject name..." />
  </div>

  <!-- Room Usage Analytics -->
  <div class="analytics-section" id="analyticsSection" style="display: none;">
    <div class="analytics-header">
      <span class="analytics-icon">ğŸ“Š</span>
      <h4>Top 10 Most Used Rooms This Week</h4>
    </div>
    <div class="chart-container">
      <canvas id="roomUsageChart"></canvas>
    </div>
    <div class="room-legend" id="roomLegend"></div>
  </div>

  <!-- Content -->
  <div id="sectionsContent">
    <div class="loading">Loading enrolled sessions and subject sections</div>
  </div>
</div>

<script src="../../JS/Authenticate.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
  const userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
  
  if (!userSession || !userSession.login_name) {
    document.getElementById('sectionsContent').innerHTML = 
      '<div class="empty-message">Session error. Please refresh the page.</div>';
    return;
  }

  const staffNo = userSession.login_name;

  const hariMap = { 2: "Mon", 3: "Tue", 4: "Wed", 5: "Thu", 6: "Fri", 7: "Sat", 8: "Sun" };
  const masaMap = {
    2: "08:00â€“09:00", 3: "09:00â€“10:00", 4: "10:00â€“11:00", 5: "11:00â€“12:00",
    6: "12:00â€“13:00", 7: "13:00â€“14:00", 8: "14:00â€“15:00", 9: "15:00â€“16:00", 10: "16:00â€“17:00"
  };

  const ITEMS_PER_PAGE = 10;
  let currentPage = 1;
  let allEnrichedData = [];
  let currentSesi = '';
  let currentSemester = '';
  let totalPages = 0;
  let roomUsageChart = null;
  let allLecturers = [];

  // Green color palette for the chart
  const greenColors = [
    '#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0',
    '#047857', '#065f46', '#14532d', '#15803d', '#166534'
  ];

  document.getElementById("searchInput").addEventListener("input", filterAndRender);
  document.getElementById("sessionSelect").addEventListener("change", handleSessionChange);
  document.getElementById("semesterSelect").addEventListener("change", handleSemesterChange);
  document.getElementById("lecturerFilter").addEventListener("change", filterAndRender);

  initAndLoad();

  async function initAndLoad() {
    const contentEl = document.getElementById("sectionsContent");
    const sessionSelect = document.getElementById("sessionSelect");
    const semesterSelect = document.getElementById("semesterSelect");

    try {
      // First, load lecturers for filter
      await loadLecturers();

      const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${staffNo}`;
      const res = await fetch(url);
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        contentEl.innerHTML = `<div class="empty-message">No enrolled subjects found.</div>`;
        return;
      }

      const sessions = {};
      data.forEach(item => {
        const sesi = item.sesi || 'Unknown';
        const sem = item.semester || 'N/A';
        if (!sessions[sesi]) sessions[sesi] = new Set();
        sessions[sesi].add(sem);
      });

      const sortedSessions = Object.keys(sessions).sort((a, b) => {
        const [y1] = a.split('/');
        const [y2] = b.split('/');
        return parseInt(y2) - parseInt(y1);
      });

      let sessionOptions = '<option value="">-- Select Session --</option>';
      sortedSessions.forEach(s => {
        sessionOptions += `<option value="${s}">${s}</option>`;
      });
      sessionSelect.innerHTML = sessionOptions;

      if (sortedSessions.length > 0) {
        const latestSesi = sortedSessions[0];
        sessionSelect.value = latestSesi;
        const latestSem = Array.from(sessions[latestSesi]).sort((a, b) => b - a)[0];
        semesterSelect.innerHTML = Array.from(sessions[latestSesi]).sort((a, b) => b - a)
          .map(sem => `<option value="${sem}" ${sem == latestSem ? 'selected' : ''}>Semester ${sem}</option>`)
          .join('');
        
        currentSesi = latestSesi;
        currentSemester = latestSem;
        await loadAllSections();
      } else {
        contentEl.innerHTML = `<div class="empty-message">No sessions available.</div>`;
      }
    } catch (err) {
      contentEl.innerHTML = `<div class="empty-message">Failed to load sessions.</div>`;
      console.error(err);
    }
  }

  async function loadLecturers() {
    try {
      const res = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah`);
      const lecturers = await res.json();
      
      if (Array.isArray(lecturers)) {
        allLecturers = lecturers;
        const lecturerFilter = document.getElementById('lecturerFilter');
        
        // Sort lecturers by name
        lecturers.sort((a, b) => {
          const nameA = (a.nama_pensyarah || a.nama || '').toLowerCase();
          const nameB = (b.nama_pensyarah || b.nama || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });
        
        lecturers.forEach(lecturer => {
          const name = lecturer.nama_pensyarah || lecturer.nama || 'Unknown';
          const staffNumber = lecturer.no_pekerja || lecturer.kod_pekerja || '';
          if (name && name !== 'Unknown') {
            const option = document.createElement('option');
            option.value = staffNumber;
            option.textContent = name;
            lecturerFilter.appendChild(option);
          }
        });
      }
    } catch (err) {
      console.error("Error loading lecturers:", err);
    }
  }

  function handleSessionChange() {
    const sesi = document.getElementById("sessionSelect").value;
    const semesterSelect = document.getElementById("semesterSelect");
    if (!sesi) {
      semesterSelect.innerHTML = '<option>Select session first</option>';
      return;
    }
    fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${encodeURIComponent(staffNo)}`)
      .then(r => r.json())
      .then(data => {
        const sessions = {};
        data.forEach(item => {
          const s = item.sesi || 'Unknown';
          const sem = item.semester || 'N/A';
          if (!sessions[s]) sessions[s] = new Set();
          sessions[s].add(sem);
        });
        if (sessions[sesi]) {
          semesterSelect.innerHTML = Array.from(sessions[sesi]).sort((a, b) => b - a)
            .map(sem => `<option value="${sem}">Semester ${sem}</option>`)
            .join('');
          currentSesi = sesi;
          currentSemester = semesterSelect.value;
          loadAllSections();
        }
      });
  }

  function handleSemesterChange() {
    currentSemester = document.getElementById("semesterSelect").value;
    if (currentSesi && currentSemester) {
      loadAllSections();
    }
  }

  async function loadAllSections() {
    const contentEl = document.getElementById("sectionsContent");
    if (!currentSesi || !currentSemester) return;

    contentEl.innerHTML = "<div class='loading'>Loading all valid subject sections</div>";

    try {
      const resSec = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}`);
      const allSubjects = await resSec.json();

      const validSubjects = allSubjects
        .filter(subj => subj.seksyen_list && Array.isArray(subj.seksyen_list))
        .map(subj => {
          const validSections = subj.seksyen_list.filter(sec => (sec.pensyarah || '').trim() && (sec.bil_pelajar || 0) > 0);
          return validSections.length > 0 ? { ...subj, seksyen_list: validSections } : null;
        })
        .filter(Boolean);

      const fetchPromises = [];
      const roomUsageMap = {};

      validSubjects.forEach(subj => {
        subj.seksyen_list.forEach(sec => {
          fetchPromises.push((async () => {
            try {
              const kod = subj.kod_subjek;
              const nama = subj.nama_subjek;
              const seksyen = sec.seksyen;
              const lecturer = sec.pensyarah;
              const enrolled = sec.bil_pelajar;

              const res = await fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}&kod_subjek=${encodeURIComponent(kod)}&seksyen=${encodeURIComponent(seksyen)}`);
              const rawJadual = await res.json();

              const sorted = (Array.isArray(rawJadual) ? rawJadual : [])
                .filter(e => e.hari && e.masa)
                .sort((a, b) => a.hari - b.hari || a.masa - b.masa);

              // Track room usage
              sorted.forEach(entry => {
                const roomName = entry.ruang?.nama_ruang_singkatan || entry.ruang?.kod_ruang;
                if (roomName && roomName !== 'â€”') {
                  roomUsageMap[roomName] = (roomUsageMap[roomName] || 0) + 1;
                }
              });

              const mergedEntries = [];
              for (let i = 0; i < sorted.length; i++) {
                let startSlot = sorted[i].masa;
                let endSlot = sorted[i].masa;
                const day = sorted[i].hari;
                const roomName = sorted[i].ruang?.nama_ruang_singkatan || sorted[i].ruang?.kod_ruang || 'â€”';

                while (i + 1 < sorted.length && 
                       sorted[i+1].hari === day && 
                       sorted[i+1].masa === endSlot + 1 && 
                       (sorted[i+1].ruang?.nama_ruang_singkatan || sorted[i+1].ruang?.kod_ruang || 'â€”') === roomName) {
                  endSlot = sorted[i+1].masa;
                  i++;
                }

                const startTime = masaMap[startSlot]?.split('â€“')[0] || 'â€”';
                const endTime = masaMap[endSlot]?.split('â€“')[1] || 'â€”';
                mergedEntries.push({
                  day: hariMap[day] || 'â€”',
                  time: `${startTime}â€“${endTime}`,
                  room: roomName
                });
              }

              return { 
                kod, 
                nama, 
                seksyen, 
                lecturer, 
                enrolled, 
                scheduleEntries: mergedEntries,
                searchable: `${kod} ${nama} ${lecturer}`.toLowerCase()
              };
            } catch (err) {
              console.error("Error loading section:", err);
              return null;
            }
          })());
        });
      });

      allEnrichedData = (await Promise.all(fetchPromises)).filter(Boolean);
      
      // Update room usage analytics
      updateRoomUsageChart(roomUsageMap);
      
      totalPages = Math.ceil(allEnrichedData.length / ITEMS_PER_PAGE);
      currentPage = 1;
      filterAndRender();
    } catch (err) {
      contentEl.innerHTML = `<div class="empty-message">Error loading sections: ${err.message}</div>`;
      console.error(err);
    }
  }

  function updateRoomUsageChart(roomUsageMap) {
    const sortedRooms = Object.entries(roomUsageMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    if (sortedRooms.length === 0) {
      document.getElementById('analyticsSection').style.display = 'none';
      return;
    }

    document.getElementById('analyticsSection').style.display = 'block';

    const labels = sortedRooms.map(([room]) => room);
    const data = sortedRooms.map(([, count]) => count);

    // Destroy previous chart if exists
    if (roomUsageChart) {
      roomUsageChart.destroy();
    }

    const ctx = document.getElementById('roomUsageChart').getContext('2d');
    roomUsageChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: greenColors,
          borderColor: '#ffffff',
          borderWidth: 3,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(5, 150, 105, 0.95)',
            titleFont: {
              size: 16,
              weight: 'bold'
            },
            bodyFont: {
              size: 14
            },
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} hours (${percentage}%)`;
              }
            }
          }
        },
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1500,
          easing: 'easeInOutQuart'
        }
      }
    });

    // Update legend
    const legendHTML = sortedRooms.map(([room, count], index) => {
      const total = data.reduce((a, b) => a + b, 0);
      const percentage = ((count / total) * 100).toFixed(1);
      return `
        <div class="legend-item">
          <div class="legend-color" style="background-color: ${greenColors[index]}"></div>
          <span class="legend-text">${room}</span>
          <span class="legend-count">${count}h (${percentage}%)</span>
        </div>
      `;
    }).join('');

    document.getElementById('roomLegend').innerHTML = legendHTML;
  }

  function filterAndRender() {
    const query = document.getElementById("searchInput").value.toLowerCase();
    const selectedLecturer = document.getElementById("lecturerFilter").value;
    
    let filteredData = allEnrichedData;

    if (query) {
      filteredData = filteredData.filter(item => item.searchable.includes(query));
    }

    if (selectedLecturer) {
      // Find lecturer name from staff number
      const lecturer = allLecturers.find(l => 
        (l.no_pekerja === selectedLecturer || l.kod_pekerja === selectedLecturer)
      );
      
      if (lecturer) {
        const lecturerName = lecturer.nama_pensyarah || lecturer.nama;
        filteredData = filteredData.filter(item => 
          item.lecturer && item.lecturer.toLowerCase().includes(lecturerName.toLowerCase())
        );
      }
    }

    totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const pageData = filteredData.slice(startIndex, startIndex + ITEMS_PER_PAGE);

    renderSections(pageData, filteredData.length);
  }

  function renderSections(pageData, totalItems) {
    const contentEl = document.getElementById("sectionsContent");
    const grouped = {};

    pageData.forEach(item => {
      if (!grouped[item.kod]) {
        grouped[item.kod] = { kod: item.kod, nama: item.nama, sections: [] };
      }
      grouped[item.kod].sections.push(item);
    });

    let html = `<div class="summary">ğŸ“Š Showing ${pageData.length} of ${totalItems} sections | Page ${currentPage} of ${totalPages}</div>`;

    if (totalItems === 0) {
      html += `<div class="empty-message">ğŸ” No sections match your search.</div>`;
    } else {
      Object.values(grouped).forEach(group => {
        html += `
          <div class="subject-card">
            <header><h5>ğŸ“š ${group.kod} â€“ ${group.nama}</h5></header>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Section</th>
                    <th>ğŸ‘¨â€ğŸ« Lecturer</th>
                    <th>ğŸ‘¥ Students</th>
                    <th>ğŸ“… Schedule (Day â€“ Time â€“ Room)</th>
                  </tr>
                </thead>
                <tbody>`;
        group.sections.forEach(sec => {
          const scheduleHtml = sec.scheduleEntries.length > 0
            ? sec.scheduleEntries.map(e => `<div class="schedule-entry"><strong>${e.day}</strong> | ${e.time} | ${e.room}</div>`).join('')
            : '<span style="color:#999;">No schedule</span>';
          html += `<tr><td><strong>${sec.seksyen}</strong></td><td>${sec.lecturer}</td><td>${sec.enrolled}</td><td>${scheduleHtml}</td></tr>`;
        });
        html += `</tbody></table></div></div>`;
      });

      html += `
        <div class="pagination">
          <button ${currentPage <= 1 ? 'disabled' : ''} onclick="changeSubjectSectionPage(${currentPage - 1})">â—€ Prev</button>
          <span class="page-info">Page ${currentPage} of ${totalPages}</span>
          <button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changeSubjectSectionPage(${currentPage + 1})">Next â–¶</button>
        </div>`;
    }

    contentEl.innerHTML = html;
  }

  window.changeSubjectSectionPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    filterAndRender();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
})();
</script>