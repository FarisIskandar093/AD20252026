<!DOCTYPE html>
<html>
<head>
    <title>My Teaching Schedule</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="Styles/MyTimetableStyle.css"> 
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="../../JS/Authenticate.js"></script>
</head>

<body class="w3-container">

<!-- Decorative Elements -->
<div class="decorative-leaf leaf-1"></div>
<div class="decorative-leaf leaf-2"></div>
<div class="decorative-leaf leaf-3"></div>

<div class="page-header">
    <h2 class="w3-center animated-title">üë®‚Äçüè´ My Teaching Schedule</h2>
</div>

<div class="info-box">
    <div class="info-card">
        <span class="info-icon">üë®‚Äçüè´</span>
        <div class="info-content">
            <label>Lecturer:</label>
            <span id="lecturerName">Loading...</span>
        </div>
    </div>
    <div class="info-card">
        <span class="info-icon">üéì</span>
        <div class="info-content">
            <label>Staff No:</label>
            <span id="staffNo">Loading...</span>
        </div>
    </div>
    <div class="info-card">
        <span class="info-icon">üìö</span>
        <div class="info-content">
            <label>Session/Semester:</label>
            <span id="sessionSem">Loading...</span>
        </div>
    </div>
</div>

<div class="loading" id="loadingMsg">
    <div class="loading-spinner"></div>
    <p>üîÑ Loading your teaching schedule from TTMS...</p>
</div>

<div id="freeTimeChartDiv" style="max-width: 100%; height: 400px; margin-bottom: 2rem; overflow: hidden;"></div>

<div class="timetable-container">
    <table class="w3-table-all timetable-table" id="timetableTable" style="display:none;">
        <thead>
            <tr>
                <th class="day-header">Day</th>
                <th>8:00 - 9:00</th>
                <th>9:00 - 10:00</th>
                <th>10:00 - 11:00</th>
                <th>11:00 - 12:00</th>
                <th>12:00 - 13:00</th>
                <th>BREAK</th>
                <th>14:00 - 15:00</th>
                <th>15:00 - 16:00</th>
                <th>16:00 - 17:00</th>
                <th>17:00 - 18:00</th>
            </tr>
        </thead>
        <tbody id="timetableBody"></tbody>
    </table>
</div>

<br>

<div id="courseListSection" style="display:none;">
    <div class="section-header">
        <h3 class="w3-center">üìö Courses I'm Teaching This Semester</h3>
    </div>
    
    <table class="w3-table-all w3-hoverable course-table">
        <thead>
            <tr class="w3-light-grey">
                <th>No.</th>
                <th>Course Code</th>
                <th>Course Name</th>
                <th>Section</th>
                <th>Students</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="courseListBody"></tbody>
    </table>
</div>

<br>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
$(document).ready(function() {

    // --- GLOBAL TRACKING FOR TEACHING TIME ---
    const HOURS_PER_DAY = 10;
    let occupiedSlots = new Set();
    
    const DAYS_OF_WEEK = {
        2: 'Monday',
        3: 'Tuesday',
        4: 'Wednesday',
        5: 'Thursday',
        6: 'Friday'
    };

    // ==========================================
    // 1. AUTO-GET STAFF NO FROM localStorage
    // ==========================================
    const userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    
    if (!userSession) {
        window.location.replace("Login.html");
        return;
    }

    const staffNo = userSession.login_name;  
    const fullName = userSession.full_name;
    $("#lecturerName").text(fullName);
    $("#staffNo").text(staffNo);

    console.log("‚úÖ Lecturer Detected:");
    console.log("‚úÖ Staff No:", staffNo);
    console.log("‚úÖ Lecturer Name:", fullName);

    // ==========================================
    // 2. GET CURRENT SESSION/SEMESTER & START EXECUTION
    // ==========================================
    let currentSesi = window.parent.currentSesi;
    let currentSemester = window.parent.currentSemester;
    
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(startExecution);
    
    function startExecution() {
        if (!currentSesi || !currentSemester) {
            console.warn("‚ö†Ô∏è Session/Semester not available from parent, fetching...");
            fetchCurrentSession().then(() => {
                loadTeachingSchedule(staffNo, currentSesi, currentSemester);
            });
        } else {
            $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
            console.log("‚úÖ Using session:", currentSesi, "Semester:", currentSemester);
            loadTeachingSchedule(staffNo, currentSesi, currentSemester);
        }
    }

    // ==========================================
    // FUNCTIONS
    // ==========================================

    function fetchCurrentSession() {
        return fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
            .then(res => res.json())
            .then(sessemList => {
                const active = sessemList.find(s => s.sesi_semester_id) || sessemList[0];
                currentSesi = active.sesi;
                currentSemester = active.semester;
                $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
                console.log("‚úÖ Fetched session:", currentSesi, currentSemester);
            })
            .catch(err => {
                console.error("‚ùå Error fetching session:", err);
                $("#sessionSem").text("Error loading session");
            });
    }

    function loadTeachingSchedule(staffNo, sesi, semester) {
        buildEmptyTable();
        fetchTeachingSubjects(staffNo, sesi, semester);
    }

    // ==========================================
    // 3. BUILD EMPTY TIMETABLE GRID
    // ==========================================
    function buildEmptyTable() {
        let body = "";
        for (let day = 2; day <= 6; day++) {  
            body += "<tr>";
            body += `<td class="day-column"><strong>${DAYS_OF_WEEK[day]}</strong></td>`;
            
            for (let hour = 1; hour <= 10; hour++) {
                if (hour === 6) {
                    body += `<td class="break-slot">BREAK</td>`;
                } else {
                    body += `<td data-day='${day}' data-time='${hour}'></td>`;
                }
            }
            body += "</tr>";
        }
        $("#timetableBody").html(body);
        
        occupiedSlots.clear();
    }

    // ==========================================
    // 4. FETCH LECTURER'S TEACHING SUBJECTS
    // ==========================================
    function fetchTeachingSubjects(staffNo, sesi, semester) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah_subjek&no_pekerja=${staffNo}`;

        fetch(url)
            .then(res => res.json())
            .then(subjects => {
                const teachingSubjects = subjects.filter(s => 
                    s.sesi === sesi && s.semester == semester
                );

                if (teachingSubjects.length === 0) {
                    $("#loadingMsg").html("‚ö†Ô∏è No teaching assignments found for this semester.");
                    drawTeachingTimeChart(); 
                    return;
                }

                displayTeachingList(teachingSubjects);
                let promises = teachingSubjects.map(subj => fetchSubjectTimetable(subj));

                Promise.all(promises).then(() => {
                    $("#loadingMsg").hide();
                    $("#timetableTable").show();
                    console.log("‚úÖ Teaching schedule loaded!");
                    
                    drawTeachingTimeChart(); 
                });
            })
            .catch(err => {
                console.error("‚ùå Error fetching teaching subjects:", err);
                $("#loadingMsg").html("‚ùå Error loading teaching schedule.");
            });
    }

    // ==========================================
    // 4.5 DISPLAY TEACHING LIST
    // ==========================================
    function displayTeachingList(courses) {
        $("#courseListBody").empty();
        
        courses.forEach((course, index) => {
            // Fetch student count for each course
            fetch(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&sesi=${currentSesi}&semester=${currentSemester}&kod_subjek=${course.kod_subjek}&seksyen=${course.seksyen}`)
                .then(res => res.json())
                .then(students => {
                    const studentCount = Array.isArray(students) ? students.length : 0;
                    
                    const row = `
                        <tr class="course-row">
                            <td>${index + 1}</td>
                            <td><strong>${course.kod_subjek}</strong></td>
                            <td>${course.nama_subjek}</td>
                            <td class="w3-center">${course.seksyen}</td>
                            <td class="w3-center"><span class="w3-tag w3-blue">${studentCount}</span></td>
                            <td class="w3-center"><span class="w3-tag w3-green">Teaching</span></td>
                        </tr>
                    `;
                    $("#courseListBody").append(row);
                })
                .catch(err => {
                    const row = `
                        <tr class="course-row">
                            <td>${index + 1}</td>
                            <td><strong>${course.kod_subjek}</strong></td>
                            <td>${course.nama_subjek}</td>
                            <td class="w3-center">${course.seksyen}</td>
                            <td class="w3-center"><span class="w3-tag w3-grey">?</span></td>
                            <td class="w3-center"><span class="w3-tag w3-green">Teaching</span></td>
                        </tr>
                    `;
                    $("#courseListBody").append(row);
                });
        });

        $("#courseListSection").show();
    }

    // ==========================================
    // 5. FETCH TIMETABLE PER SUBJECT
    // ==========================================
    function fetchSubjectTimetable(subject) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;

        return fetch(url)
            .then(res => res.json())
            .then(times => {
                if (Array.isArray(times)) {
                    times.forEach(slot => {
                        placeIntoTable(subject, slot);
                    });
                } 
            })
            .catch(err => {
                console.error(`‚ùå Error fetching timetable for ${subject.kod_subjek}:`, err);
            });
    }

    // ==========================================
    // 6. PLACE SUBJECT INTO TIMETABLE GRID
    // ==========================================
    function mapTTMSTimeToTableTime(masa) {
        if (masa <= 5) {
            return masa-1;
        } else if (masa >= 7) {
            return masa - 1;
        }
        return null;
    }
    
    function placeIntoTable(subject, slot) {
        const day = slot.hari;      
        const time = mapTTMSTimeToTableTime(slot.masa);

        if (time === null) return;
        
        const slotKey = `${day}-${time}`;
        occupiedSlots.add(slotKey);

        const room = slot.ruang.nama_ruang_singkatan || slot.ruang.kod_ruang || 'N/A';

        const cell = $(`td[data-day='${day}'][data-time='${time}']`);

        const slotHTML = `
            <div class="slot">
                <div class="slot-header">
                    <strong>${subject.kod_subjek}</strong>
                    <span class="slot-section">Sec ${subject.seksyen}</span>
                </div>
                <div class="slot-title">${subject.nama_subjek}</div>
                <div class="slot-room">
                    <span class="room-icon">üìç</span> ${room}
                </div>
                <div class="slot-teaching">
                    <span class="teaching-icon">üë®‚Äçüè´</span> You Teach
                </div>
            </div>
        `;

        cell.append(slotHTML);
    }

    // ==========================================
    // 8. CHARTING LOGIC (TEACHING TIME CHART)
    // ==========================================
    function drawTeachingTimeChart() {
        // 1. Initialize data structure for 5 days
        const dailyDataMap = {};
        for (let dayCode = 2; dayCode <= 6; dayCode++) {
            dailyDataMap[dayCode] = {
                dayName: DAYS_OF_WEEK[dayCode],
                teaching: 0,
                free: HOURS_PER_DAY
            };
        }

        // 2. Count teaching hours per day
        occupiedSlots.forEach(slotKey => {
            const dayCode = slotKey.split('-')[0];
            
            if (dailyDataMap[dayCode]) {
                dailyDataMap[dayCode].teaching++;
                dailyDataMap[dayCode].free--;
            }
        });
        
        // 3. Prepare Google Chart DataTable
        const dataArray = [
          ['Day', 'Teaching Hours', 'Free Hours']
        ];

        for (let dayCode = 2; dayCode <= 6; dayCode++) {
            const dayEntry = dailyDataMap[dayCode];
            dataArray.push([
                dayEntry.dayName,
                dayEntry.teaching,
                dayEntry.free
            ]);
        }

        const data = google.visualization.arrayToDataTable(dataArray);

        // 4. Define Chart Options
        const options = {
          title: 'Weekly Teaching Allocation (8:00 - 18:00)',
          isStacked: true,
          legend: { position: 'top', maxLines: 3 },
          vAxis: {
            title: 'Hours',
            minValue: 0,
            maxValue: HOURS_PER_DAY,
            ticks: [0, 2, 4, 6, 8, 10]
          },
          hAxis: {
            title: 'Day of Week'
          },
          colors: ['#3b82f6', '#d1d5db'], // Blue for teaching
          height: 400,
          chartArea: {
            width: '85%',
            height: '70%'
          }
        };

        // 5. Draw the Chart
        const chart = new google.visualization.ColumnChart(document.getElementById('freeTimeChartDiv'));
        chart.draw(data, options);
    }
});
</script>
</body>
</html>