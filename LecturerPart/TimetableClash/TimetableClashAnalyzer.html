<!-- LecturerAnalytics.html - Content to be loaded inside Main.html -->
<link rel="stylesheet" href="Styles/EnrolledStyle.css">

<div class="lecturer-analytics-container">
  <!-- Page Header -->
  <div class="analytics-card">
    <div class="header-section">
      <div class="header-icon">ğŸ‘¨â€ğŸ«</div>
      <h1 class="header-titles">Lecturer Enrollment Analytics</h1>
      <p class="header-subtitle">Top 10 Most Popular Lecturers by Total Student Enrollment</p>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="sessionSelect">ğŸ—“ï¸ Session</label>
        <select id="sessionSelect">
          <option value="">Loading...</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="semesterSelect">ğŸ“… Semester</label>
        <select id="semesterSelect">
          <option value="">Select session first</option>
        </select>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="ğŸ” Search lecturer by name..." />
      <div class="search-info" id="searchInfo"></div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview" id="statsOverview">
      <div class="stat-box">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value" id="totalStudents">-</div>
        <div class="stat-label">Total Students</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">ğŸ‘¨â€ğŸ«</div>
        <div class="stat-value" id="totalLecturers">-</div>
        <div class="stat-label">Active Lecturers</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">ğŸ“š</div>
        <div class="stat-value" id="totalSections">-</div>
        <div class="stat-label">Course Sections</div>
      </div>
      <div class="stat-box">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-value" id="avgStudents">-</div>
        <div class="stat-label">Avg per Lecturer</div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section">
      <h2 class="section-title">
        <span class="section-icon">ğŸ†</span>
        <span id="chartTitle">Top 10 Lecturers Ranking</span>
      </h2>
      <div id="lecturerChart" class="loading">Loading lecturer data</div>
    </div>
  </div>
</div>

<script src="../../JS/Authenticate.js"></script>
<script>
(function() {
  // Get user from parent window's global variable
  const userSession = window.userSession;
  
  if (!userSession || !userSession.login) {
    document.getElementById('lecturerChart').innerHTML = 
      '<div class="empty-state"><div class="empty-state-icon">ğŸš«</div><div class="empty-state-text">Session error. Please refresh the page.</div></div>';
    return;
  }

  const matricNo = userSession.login;
  const sessionId = userSession.session_id || '';

  let currentSesi = '';
  let currentSemester = '';
  let allLecturerData = [];
  let displayedLecturers = [];

  document.getElementById("sessionSelect").addEventListener("change", handleSessionChange);
  document.getElementById("semesterSelect").addEventListener("change", handleSemesterChange);
  document.getElementById("searchInput").addEventListener("input", handleSearch);

  initAndLoad();

  async function initAndLoad() {
    const chartEl = document.getElementById("lecturerChart");
    const sessionSelect = document.getElementById("sessionSelect");
    const semesterSelect = document.getElementById("semesterSelect");

    try {
      // Fetch available sessions/semesters
      const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester`;
      const res = await fetch(url);
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        chartEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">No sessions found.</div></div>`;
        return;
      }

      // Group by session
      const sessions = {};
      data.forEach(item => {
        const sesi = item.sesi || 'Unknown';
        const sem = item.semester || 'N/A';
        if (!sessions[sesi]) sessions[sesi] = new Set();
        sessions[sesi].add(sem);
      });

      // Sort sessions (newest first)
      const sortedSessions = Object.keys(sessions).sort((a, b) => {
        const [y1] = a.split('/');
        const [y2] = b.split('/');
        return parseInt(y2) - parseInt(y1);
      });

      // Populate session dropdown
      let sessionOptions = '<option value="">-- Select Session --</option>';
      sortedSessions.forEach(s => {
        sessionOptions += `<option value="${s}">${s}</option>`;
      });
      sessionSelect.innerHTML = sessionOptions;

      // Auto-select latest session and semester
      if (sortedSessions.length > 0) {
        const latestSesi = sortedSessions[0];
        sessionSelect.value = latestSesi;
        const semesters = Array.from(sessions[latestSesi]).sort((a, b) => b - a);
        const latestSem = semesters[0];
        
        semesterSelect.innerHTML = semesters
          .map(sem => `<option value="${sem}" ${sem == latestSem ? 'selected' : ''}>Semester ${sem}</option>`)
          .join('');
        
        currentSesi = latestSesi;
        currentSemester = latestSem;
        await loadLecturerAnalytics();
      } else {
        chartEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">No sessions available.</div></div>`;
      }
    } catch (err) {
      chartEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">Failed to load sessions: ${err.message}</div></div>`;
      console.error(err);
    }
  }

  async function handleSessionChange() {
    const sesi = document.getElementById("sessionSelect").value;
    const semesterSelect = document.getElementById("semesterSelect");
    
    if (!sesi) {
      semesterSelect.innerHTML = '<option>Select session first</option>';
      return;
    }

    try {
      const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester`;
      const res = await fetch(url);
      const data = await res.json();
      
      const sessions = {};
      data.forEach(item => {
        const s = item.sesi || 'Unknown';
        const sem = item.semester || 'N/A';
        if (!sessions[s]) sessions[s] = new Set();
        sessions[s].add(sem);
      });

      if (sessions[sesi]) {
        const semesters = Array.from(sessions[sesi]).sort((a, b) => b - a);
        semesterSelect.innerHTML = semesters
          .map(sem => `<option value="${sem}">Semester ${sem}</option>`)
          .join('');
        currentSesi = sesi;
        currentSemester = semesterSelect.value;
        await loadLecturerAnalytics();
      }
    } catch (err) {
      console.error("Error loading semesters:", err);
    }
  }

  async function handleSemesterChange() {
    currentSemester = document.getElementById("semesterSelect").value;
    if (currentSesi && currentSemester) {
      await loadLecturerAnalytics();
    }
  }

  async function loadLecturerAnalytics() {
    const chartEl = document.getElementById("lecturerChart");
    
    if (!currentSesi || !currentSemester) return;

    chartEl.innerHTML = "<div class='loading'>Analyzing lecturer enrollment data</div>";

    try {
      // Fetch all subject sections for the selected session/semester
      const sectionsUrl = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${encodeURIComponent(currentSesi)}&semester=${encodeURIComponent(currentSemester)}`;
      const sectionsRes = await fetch(sectionsUrl);
      const allSections = await sectionsRes.json();

      if (!Array.isArray(allSections) || allSections.length === 0) {
        chartEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">No sections found for this session/semester.</div></div>`;
        return;
      }

      // Aggregate lecturer data
      const lecturerMap = {};
      let totalStudentsCount = 0;
      let totalSectionsCount = 0;

      allSections.forEach(subject => {
        if (subject.seksyen_list && Array.isArray(subject.seksyen_list)) {
          subject.seksyen_list.forEach(section => {
            const lecturerName = (section.pensyarah || '').trim();
            const studentCount = parseInt(section.bil_pelajar) || 0;

            // Only count valid sections with lecturer and students
            if (lecturerName && studentCount > 0) {
              if (!lecturerMap[lecturerName]) {
                lecturerMap[lecturerName] = {
                  name: lecturerName,
                  students: 0,
                  courses: 0,
                  sections: []
                };
              }

              lecturerMap[lecturerName].students += studentCount;
              lecturerMap[lecturerName].courses += 1;
              lecturerMap[lecturerName].sections.push({
                subject: subject.kod_subjek,
                section: section.seksyen,
                students: studentCount
              });

              totalStudentsCount += studentCount;
              totalSectionsCount += 1;
            }
          });
        }
      });

      // Convert to array and sort by student count
      allLecturerData = Object.values(lecturerMap)
        .sort((a, b) => b.students - a.students);

      // Initialize displayed lecturers (top 10 by default)
      displayedLecturers = allLecturerData.slice(0, 10);

      // Update stats
      const totalLecturers = Object.keys(lecturerMap).length;
      const avgStudents = totalLecturers > 0 ? Math.round(totalStudentsCount / totalLecturers) : 0;

      document.getElementById('totalStudents').textContent = totalStudentsCount.toLocaleString();
      document.getElementById('totalLecturers').textContent = totalLecturers;
      document.getElementById('totalSections').textContent = totalSectionsCount;
      document.getElementById('avgStudents').textContent = avgStudents;

      // Clear search
      document.getElementById('searchInput').value = '';
      updateSearchInfo();

      // Render chart
      renderLecturerChart(displayedLecturers);

    } catch (err) {
      chartEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">Error loading data: ${err.message}</div></div>`;
      console.error(err);
    }
  }

  function handleSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (!query) {
      // No search - show top 10
      displayedLecturers = allLecturerData.slice(0, 10);
    } else {
      // Filter lecturers by name
      displayedLecturers = allLecturerData.filter(lecturer => 
        lecturer.name.toLowerCase().includes(query)
      );
    }
    
    updateSearchInfo();
    renderLecturerChart(displayedLecturers);
  }

  function updateSearchInfo() {
    const searchInfo = document.getElementById('searchInfo');
    const query = document.getElementById('searchInput').value.trim();
    
    if (!query) {
      searchInfo.textContent = '';
      return;
    }
    
    if (displayedLecturers.length === 0) {
      searchInfo.innerHTML = '<span class="no-results">âŒ No lecturers found matching your search</span>';
    } else if (displayedLecturers.length === 1) {
      searchInfo.innerHTML = `<span class="results-found">âœ… Found 1 lecturer</span>`;
    } else {
      searchInfo.innerHTML = `<span class="results-found">âœ… Found ${displayedLecturers.length} lecturers</span>`;
    }
  }

  function renderLecturerChart(lecturers) {
    const chartContainer = document.getElementById('lecturerChart');
    const chartTitle = document.getElementById('chartTitle');
    const query = document.getElementById('searchInput').value.trim();
    
    // Update title based on search
    if (query) {
      chartTitle.textContent = `Search Results (${lecturers.length})`;
    } else {
      chartTitle.textContent = 'Top 10 Lecturers Ranking';
    }
    
    if (lecturers.length === 0) {
      chartContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <div class="empty-state-text">${query ? 'No lecturers match your search' : 'No lecturer data available for this period'}</div>
        </div>
      `;
      return;
    }

    const maxStudents = Math.max(...lecturers.map(l => l.students));
    
    const html = lecturers.map((lecturer, index) => {
      const percentage = (lecturer.students / maxStudents) * 100;
      const rank = index + 1;
      const rankClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : '';
      const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
      
      return `
        <div class="lecturer-item">
          <div class="lecturer-rank ${rankClass}">${rank}</div>
          <div class="lecturer-info">
            <div class="lecturer-details">
              <div class="lecturer-name">
                ${lecturer.name}
                ${medal}
              </div>
              <div class="lecturer-courses">
                ğŸ“š ${lecturer.courses} Section${lecturer.courses > 1 ? 's' : ''}
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" style="width: ${percentage}%">
                  <div class="student-count">
                    ğŸ‘¥ ${lecturer.students.toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    chartContainer.innerHTML = `<div class="lecturer-list">${html}</div>`;
  }
})();
</script>