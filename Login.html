<!DOCTYPE html>
<html>
<head>
    <title>TTMS - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="Styles/loginStyle.css"> 
</head>
<body>

    <div class="welcome-text">TTMS - Visualization <br>
        Support System</div>

    <div class="logo-container">
        <img id="utm-logo" src="Logo/UTM-LOGO.png" alt="UTM Logo">
    </div>

    <div class="login-box">
        <div class="input-group">
            <label for="login">UserID</label>
            <input type="text" id="login" class="input-field" placeholder="Matric No. / Staff No." value="">
        </div>
        
        <div class="input-group">
            <label for="password">Password</label>
            <input type="password" id="password" class="input-field" placeholder="Enter your password" value="">
        </div>

        <div class="inputError"></div>
        
        <button class="login-button" id="btnLogin">LOGIN</button>
        <div class="w3-margin-top w3-center">
            <a href="AdminLogin.html" style="text-decoration: none; color: #007bff;">ðŸ‘‘ Lecturer/Admin Access</a>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        // Auto-redirect if already logged in
        const existingSession = localStorage.getItem("TTMSFC_userSession");
        if (existingSession) {
            try {
                const user = JSON.parse(existingSession);
                if (user.inferredRole === "lecturer") {
                    window.location.replace("MainLecturer.html");
                } else {
                    window.location.replace("Main.html");
                }
            } catch (e) {
                localStorage.removeItem("TTMSFC_userSession");
            }
        }

        // Check if admin already authenticated (optional)
        const adminAuth = localStorage.getItem("TTMSFC_adminAuth");
        if (adminAuth === "true") {
            window.location.replace("Admin.html");
        }

        const BASE_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi";

        $("#btnLogin").click(function() {
            const loginId = $("#login").val().trim();
            const password = $("#password").val().trim();

            $(".inputError").text("");

            if (!loginId || !password) {
                $(".inputError").text("Please enter both UserID and Password.");
                return;
            }

            // âœ… Optional: Hardcoded Admin Login (you can remove this if not needed)
            if (loginId === "admin" && password === "admin123@") {
                localStorage.setItem("TTMSFC_adminAuth", "true");
                window.location.replace("Admin.html");
                return;
            }

            const authUrl = `${BASE_URL}?entity=authentication&login=${encodeURIComponent(loginId)}&password=${encodeURIComponent(password)}`;
            
            fetch(authUrl)
                .then(res => {
                    if (!res.ok) throw new Error("credentials");
                    return res.text(); // Use text() to avoid JSON parse errors on empty responses
                })
                .then(text => {
                    if (!text.trim()) throw new Error("credentials");
                    let jsonInst;
                    try {
                        jsonInst = JSON.parse(text);
                    } catch (e) {
                        throw new Error("credentials");
                    }
                    if (!Array.isArray(jsonInst) || jsonInst.length === 0 || !jsonInst[0].session_id) {
                        throw new Error("credentials");
                    }
                    return jsonInst[0];
                })
                .then(userData => {
                    // Infer role: check description or use pelajar_subjek fallback
                    let inferredRole = "student";
                    const desc = (userData.description || "").toLowerCase().trim();
                    if (desc.includes("pensyarah") || desc.includes("lecturer") || desc.includes("staff")) {
                        inferredRole = "lecturer";
                    }

                    const sessionData = {
                        ...userData,
                        login: userData.login_name || loginId,
                        session_id: userData.session_id,
                        inferredRole: inferredRole
                    };

                    localStorage.setItem("TTMSFC_userSession", JSON.stringify(sessionData));
                    localStorage.setItem("TTMSFC_loginTimestamp", Date.now().toString());

                    alert("Successfully logged in to the system!");

                    if (inferredRole === "lecturer") {
                        window.location.replace("MainLecturer.html");
                    } else {
                        window.location.replace("Main.html");
                    }
                })
                .catch(err => {
                    if (err.message === "credentials") {
                        $(".inputError").text("Invalid credential or authentication API error!");
                    } else {
                        $(".inputError").text("Unable to connect to the server.");
                        console.error("Login Error:", err);
                    }
                });
        });

        $("#password").keypress(function(event) {
            if (event.key === "Enter") {
                $("#btnLogin").click();
            }
        });
    </script>
</body>
</html>