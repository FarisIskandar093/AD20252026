<!DOCTYPE html>
<html>
<head>
    <title>TTMS - Visualization Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    
    <link rel="stylesheet" href="Styles/mainStyle.css"> 
</head>
<body>

<div class="utm-header">
    <div class="header-title">
        TTMS - Visualization Support System
    </div>
    <div class="user-links">
        <span class="w3-large w3-hide-small">Welcome, <span id="user">???</span> |</span>
        <a href="#" id="logout">Logout</a> 
    </div>
</div>

<nav class="w3-sidebar w3-bar-block w3-light-grey">
    
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey w3-blue-dark" id="announcement-dashboard">ğŸ“¢ Announcements</a>
    
    <h5 class="w3-bar-item w3-text-gray w3-border-bottom"><b>TIMETABLE</b></h5>
    
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="my-timetable">ğŸ“… My Timetable</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="course-list">ğŸ“ My CourseList</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="room-availability">ğŸ« Room Availability</a>
    <hr>
    <h5 class="w3-bar-item w3-text-gray w3-border-bottom"><b>ANALYSIS</b></h5>
    

    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="room-usage">ğŸ“ˆ Room Usage</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="room-clash-analyzer">ğŸ¢ Room Clash Analyzer</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="lecturer-time">ğŸ§‘ğŸ»â€ğŸ« Lecturer and time clash</a>

</nav>

<div id="mainContent">
    <div class="w3-container">
        <h2>System Loading...</h2>
        <p>Initializing TTMS session and fetching current semester context. Please wait...</p>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="PageCtrl.js"></script> 
<script>
    // --- GLOBAL VARIABLES & CONSTANTS ---
    const BASE_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
    const AUTH_URL = "http://web.fc.utm.my/ttms/auth-admin.php?session_id=";
    
    // Global variables must be window-scoped to be accessible by content pages (e.g., MyTimetable.html)
    window.userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    window.adminSessionID = null;
    window.currentSesi = null;
    window.currentSemester = null;

    // --- SESSION GUARD & INITIALIZATION ---

    if (!userSession) {
        // Redirect to login if user session is not found
        window.location.replace("Login.html");
    }

    // Display user name
    $('#user').text(userSession.full_name || 'Admin');
    
    // Start Initialization Sequence
    initDashboard();

    /**
     * Executes sequential AJAX calls to fetch critical context data.
     * This uses a Promise chain to ensure variables are set before loading the default page.
     */
    function initDashboard() {
        // 1. Get Admin Session ID
        getAdminSession(userSession.session_id)
            .then(adminData => {
                window.adminSessionID = adminData.session_id;
                console.log("Admin Session ID obtained.");
                // 2. Get the current active session-semester
                return getCurrentSessionSemester();
            })
            .then(sesiData => {
                // Find the active session object
                const activeSession = Array.isArray(sesiData) ? sesiData.find(s => s.sesi_semester_id) : sesiData;

                if (activeSession) {
                    window.currentSesi = activeSession.sesi;
                    window.currentSemester = activeSession.semester;
                    console.log(`Current Sesi: ${window.currentSesi}, Semester: ${window.currentSemester}`);
                } else {
                    throw new Error("Could not determine current active session/semester.");
                }

                // *** DEFAULT VIEW: LOAD ANNOUNCEMENT.HTML ***
                // This executes ONLY after all context variables are set.
                $('#mainContent').load('Announcement.html');
                
            })
            .catch(error => {
                console.error("Initialization failed:", error);
                // Display error message if critical data fails to load
                $('#mainContent').html('<div class="w3-panel w3-red w3-margin-top"><p><strong>System Error:</strong> Failed to initialize critical context. Please check network and API access.</p></div>');
            });
    }

    // --- TTMS WEB SERVICE FETCHERS ---

    function getAdminSession(userSessionID) {
        // auth-admin.php endpoint
        return fetch(AUTH_URL + userSessionID)
            .then(res => res.json())
            .then(data => data[0] || Promise.reject("Invalid Admin Session response"));
    }

    function getCurrentSessionSemester() {
        // sesisemester entity
        return fetch(BASE_URL + "sesisemester")
            .then(res => res.json()); 
    }
    
    // --- NAVIGATION LOGIC ---

    // Function to handle content loading
    function loadContent(url) {
        $('#mainContent').load(url);
    }

    // Logout Function 
    $('#logout').click(function() {
        localStorage.removeItem("TTMSFC_userSession");
        localStorage.removeItem("TTMSFC_sessionList");
        window.location.replace("Login.html");
    });
    
    // --- MENU HANDLERS ---
    // Change the default active highlight when clicking a menu item
    function handleMenuClick(targetId, url) {
        $('.w3-bar-item.w3-blue-dark').removeClass('w3-blue-dark');
        
        let target = $(`#${targetId}`);
        if (!target.is('a')) {
             // If it's a submenu link, highlight the parent button
             target = $(`#${targetId}`).closest('.w3-dropdown-content').prev('button');
        }
        target.addClass('w3-blue-dark');
        loadContent(url);
    }

    // Default Page
    $('#announcement-dashboard').click(() => handleMenuClick('announcement-dashboard', 'StudentPart/Announcement.html'));

    // TIMETABLE Category
    $('#my-timetable').click(() => handleMenuClick('my-timetable', 'LecturerPart/Timetable/MyTimetable.html'));
    $('#course-list').click(() => handleMenuClick('course-list', 'LecturerPart/Course/LectureCourseList.html'));
    $('#room-availability').click(() => handleMenuClick('room-availability', 'LecturerPart/RoomAvailability.html'));

    // ANALYSIS Category
    $('#room-usage').click(() => handleMenuClick('room-usage', 'LecturerPart/RoomUsage/RoomUsage.html'));
    $('#room-clash-analyzer').click(() => handleMenuClick('room-clash-analyzer', 'LecturerPart/CourseList.html')); 
    $('#lecture-time').click(() => handleMenuClick('lecture-time', 'LecturerPart/TimetableClash/TimetableClashAnalyzer.html')); 

</script>
</body>
</html>