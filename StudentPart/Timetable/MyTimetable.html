<!DOCTYPE html>
<html>
<head>
    <title>My Timetable</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="Styles/MyTimetableStyle.css"> 
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body class="w3-container">

<!-- Decorative Elements -->
<div class="decorative-leaf leaf-1"></div>
<div class="decorative-leaf leaf-2"></div>
<div class="decorative-leaf leaf-3"></div>

<div class="page-header">
    <h2 class="w3-center animated-title">üìÖ My Timetable</h2>
</div>

<div class="info-box">
    <div class="info-card">
        <span class="info-icon">üë§</span>
        <div class="info-content">
            <label>Student:</label>
            <span id="studentName">Loading...</span>
        </div>
    </div>
    <div class="info-card">
        <span class="info-icon">üéì</span>
        <div class="info-content">
            <label>Matric No:</label>
            <span id="matricNo">Loading...</span>
        </div>
    </div>
    <div class="info-card">
        <span class="info-icon">üìö</span>
        <div class="info-content">
            <label>Session/Semester:</label>
            <span id="sessionSem">Loading...</span>
        </div>
    </div>
</div>

<div class="loading" id="loadingMsg">
    <div class="loading-spinner"></div>
    <p>üîÑ Loading your timetable from TTMS...</p>
</div>

<div id="freeTimeChartDiv" style="max-width: 100%; height: 400px; margin-bottom: 2rem; overflow: hidden;"></div>

<div class="timetable-container">
    <table class="w3-table-all timetable-table" id="timetableTable" style="display:none;">
        <thead>
            <tr>
                <th class="day-header">Day</th>
                <th>8:00 - 9:00</th>
                <th>9:00 - 10:00</th>
                <th>10:00 - 11:00</th>
                <th>11:00 - 12:00</th>
                <th>12:00 - 13:00</th>
                <th>BREAK</th>
                <th>14:00 - 15:00</th>
                <th>15:00 - 16:00</th>
                <th>16:00 - 17:00</th>
                <th>17:00 - 18:00</th>
            </tr>
        </thead>
        <tbody id="timetableBody"></tbody>
    </table>
</div>

<br>

<div id="courseListSection" style="display:none;">
    <div class="section-header">
        <h3 class="w3-center">üìö My Courses This Semester</h3>
    </div>
    
    <table class="w3-table-all w3-hoverable course-table">
        <thead>
            <tr class="w3-light-grey">
                <th>No.</th>
                <th>Course Code</th>
                <th>Course Name</th>
                <th>Section</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="courseListBody"></tbody>
    </table>
</div>

<br>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
$(document).ready(function() {

    // --- GLOBAL TRACKING FOR FREE TIME ---
    // Total possible slots per day: 10 hours (8:00 to 18:00)
    const HOURS_PER_DAY = 10;
    // Set stores unique occupied slots using key: 'Day-Time' (e.g., '2-4' for Mon, 10am)
    let occupiedSlots = new Set();
    
    // Day code mapping (API uses 2 for Monday, 6 for Friday)
    const DAYS_OF_WEEK = {
        2: 'Monday',
        3: 'Tuesday',
        4: 'Wednesday',
        5: 'Thursday',
        6: 'Friday'
    };

    // ==========================================
    // 1. AUTO-GET MATRIC FROM localStorage
    // ==========================================
    const userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    
    if (!userSession) {
        // Fallback for testing when localStorage is not available
        const matric = ''; 
        const fullName = '';
        $("#studentName").text(fullName);
        $("#matricNo").text(matric);
        
    } else {
        const matric = userSession.login_name;  
        const fullName = userSession.full_name;
        $("#studentName").text(fullName);
        $("#matricNo").text(matric);
    }
    
    const matric = $("#matricNo").text();
    const fullName = $("#studentName").text();

    console.log("‚úÖ Auto-detected Matric:", matric);
    console.log("‚úÖ Student Name:", fullName);


    // ==========================================
    // 2. GET CURRENT SESSION/SEMESTER & START EXECUTION
    // ==========================================
    let currentSesi = window.parent.currentSesi;
    let currentSemester = window.parent.currentSemester;
    
    // FIX: Load the chart package and wrap the entire execution inside the callback.
    // This resolves the "Must call google.charts.load" error.
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(startExecution);
    
    function startExecution() {
        if (!currentSesi || !currentSemester) {
            console.warn("‚ö†Ô∏è Session/Semester not available from parent, fetching...");
            fetchCurrentSession().then(() => {
                loadTimetable(matric, currentSesi, currentSemester);
            });
        } else {
            $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
            console.log("‚úÖ Using session:", currentSesi, "Semester:", currentSemester);
            loadTimetable(matric, currentSesi, currentSemester);
        }
    }

    // ==========================================
    // FUNCTIONS
    // ==========================================

    function fetchCurrentSession() {
        return fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
            .then(res => res.json())
            .then(sessemList => {
                const active = sessemList.find(s => s.sesi_semester_id) || sessemList[0];
                currentSesi = active.sesi;
                currentSemester = active.semester;
                $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
                console.log("‚úÖ Fetched session:", currentSesi, currentSemester);
            })
            .catch(err => {
                console.error("‚ùå Error fetching session:", err);
                $("#sessionSem").text("Error loading session");
            });
    }

    function loadTimetable(matric, sesi, semester) {
        buildEmptyTable();
        fetchStudentSubjects(matric, sesi, semester);
    }

    // ==========================================
    // 3. BUILD EMPTY TIMETABLE GRID (FLIPPED)
    // ==========================================
    function buildEmptyTable() {
        let body = "";
        // Now each row is a DAY
        for (let day = 2; day <= 6; day++) {  
            body += "<tr>";
            body += `<td class="day-column"><strong>${DAYS_OF_WEEK[day]}</strong></td>`;
            
            // Time slots: 1-5 (8:00-13:00), then BREAK, then 7-10 (14:00-18:00)
            // Slot 6 (13:00-14:00) is the break
            for (let hour = 1; hour <= 10; hour++) {
                if (hour === 6) {
                    // This is the break slot - make it non-clickable/non-data
                    body += `<td class="break-slot">BREAK</td>`;
                } else {
                    body += `<td data-day='${day}' data-time='${hour}'></td>`;
                }
            }
            body += "</tr>";
        }
        $("#timetableBody").html(body);
        
        // Clear previous tracking for fresh calculation
        occupiedSlots.clear();
    }

    // ==========================================
    // 4. FETCH STUDENT'S SUBJECTS
    // ==========================================
    function fetchStudentSubjects(matric, sesi, semester) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matric}`;

        fetch(url)
            .then(res => res.json())
            .then(subjects => {
                const currentSubjects = subjects.filter(s => 
                    s.sesi === sesi && s.semester == semester
                );

                if (currentSubjects.length === 0) {
                    $("#loadingMsg").html("‚ö†Ô∏è No subjects found for current semester.");
                    // Draw empty chart if no subjects
                    drawFreeTimeChart(); 
                    return;
                }

                displayCourseList(currentSubjects);
                let promises = currentSubjects.map(subj => fetchSubjectTimetable(subj));

                Promise.all(promises).then(() => {
                    $("#loadingMsg").hide();
                    $("#timetableTable").show();
                    console.log("‚úÖ Timetable loaded successfully!");
                    
                    // Draw the free time chart after everything is placed
                    drawFreeTimeChart(); 
                });
            })
            .catch(err => {
                console.error("‚ùå Error fetching subjects:", err);
                $("#loadingMsg").html("‚ùå Error loading subjects. Please try again.");
            });
    }

    // ==========================================
    // 4.5 DISPLAY COURSE LIST
    // ==========================================
    function displayCourseList(courses) {
        $("#courseListBody").empty();
        
        courses.forEach((course, index) => {
            let statusBadge = '';
            if (course.status === 'UM') {
                statusBadge = '<span class="w3-tag w3-green status-badge">UM</span>';
            } else if (course.status === '-') {
                statusBadge = '<span class="w3-tag w3-blue status-badge">Active</span>';
            } else {
                statusBadge = `<span class="w3-tag w3-grey status-badge">${course.status}</span>`;
            }

            const row = `
                <tr class="course-row">
                    <td>${index + 1}</td>
                    <td><strong>${course.kod_subjek}</strong></td>
                    <td>${course.nama_subjek}</td>
                    <td class="w3-center">${course.seksyen}</td>
                    <td class="w3-center">${statusBadge}</td>
                </tr>
            `;
            $("#courseListBody").append(row);
        });

        $("#courseListSection").show();
    }

    // ==========================================
    // 5. FETCH TIMETABLE PER SUBJECT
    // ==========================================
    function fetchSubjectTimetable(subject) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;

        return fetch(url)
            .then(res => res.json())
            .then(times => {
                if (Array.isArray(times)) {
                    times.forEach(slot => {
                        placeIntoTable(subject, slot);
                    });
                } 
            })
            .catch(err => {
                console.error(`‚ùå Error fetching timetable for ${subject.kod_subjek}:`, err);
            });
    }

    // ==========================================
    // 6. PLACE SUBJECT INTO TIMETABLE GRID
    // ==========================================
    function mapTTMSTimeToTableTime(masa) {
    if (masa <= 5) {
        return masa-1;        // 8‚Äì13 stays same
    } else if (masa >= 7) {
        return masa - 1;    // shift AFTER break
    }
    return null; // ignore break (masa === 6)
}

    
    function placeIntoTable(subject, slot) {
        const day = slot.hari;      
        const time = mapTTMSTimeToTableTime(slot.masa);

// Ignore break time completely
if (time === null) return;
     
        
        // Track occupied slots using the day-time key
        const slotKey = `${day}-${time}`;
        occupiedSlots.add(slotKey);

        const room = slot.ruang.nama_ruang_singkatan || slot.ruang.kod_ruang || 'N/A';

        const cell = $(`td[data-day='${day}'][data-time='${time}']`);

        const slotHTML = `
            <div class="slot">
                <div class="slot-header">
                    <strong>${subject.kod_subjek}</strong>
                    <span class="slot-section">${subject.seksyen}</span>
                </div>
                <div class="slot-title">${subject.nama_subjek}</div>
                <div class="slot-room">
                    <span class="room-icon">üìç</span> ${room}
                </div>
            </div>
        `;

        cell.append(slotHTML);
    }

    // ==========================================
    // 7. TIME FORMATTING (Corrected for TTMS API)
    // ==========================================
    function formatTime(masa) {
      
        const timeMap = {
            1: "8:00 - 9:00",
            2: "9:00 - 10:00",
            3: "10:00 - 11:00",
            4: "11:00 - 12:00",
            5: "12:00 - 13:00",
            6: "BREAK",
            7: "14:00 - 15:00",
            8: "15:00 - 16:00",
            9: "16:00 - 17:00",
            10: "17:00 - 18:00"
        };
        
        return timeMap[masa] || "Unknown";
    }

    // ==========================================
    // 8. CHARTING LOGIC (STACKED COLUMN CHART BY DAY)
    // ==========================================
    function drawFreeTimeChart() {
        // 1. Initialize data structure for 5 days
        const dailyDataMap = {};
        for (let dayCode = 2; dayCode <= 6; dayCode++) {
            dailyDataMap[dayCode] = {
                dayName: DAYS_OF_WEEK[dayCode],
                occupied: 0,
                free: HOURS_PER_DAY
            };
        }

        // 2. Count occupied hours per day
        occupiedSlots.forEach(slotKey => {
            // slotKey is 'DayCode-Time' (e.g., '2-4')
            const dayCode = slotKey.split('-')[0];
            
            if (dailyDataMap[dayCode]) {
                dailyDataMap[dayCode].occupied++;
                dailyDataMap[dayCode].free--;
            }
        });
        
        // 3. Prepare Google Chart DataTable
        const dataArray = [
          ['Day', 'Occupied Time (Hrs)', 'Free Time (Hrs)']
        ];

        // Convert the map data into the array format required by Google Charts
        for (let dayCode = 2; dayCode <= 6; dayCode++) {
            const dayEntry = dailyDataMap[dayCode];
            dataArray.push([
                dayEntry.dayName,
                dayEntry.occupied,
                dayEntry.free
            ]);
        }

        const data = google.visualization.arrayToDataTable(dataArray);

        // 4. Define Chart Options
        const options = {
          title: 'Daily Time Allocation (8:00 - 18:00)',
          isStacked: true,
          legend: { position: 'top', maxLines: 3 },
          vAxis: {
            title: 'Hours',
            minValue: 0,
            maxValue: HOURS_PER_DAY,
            ticks: [0, 2, 4, 6, 8, 10]
          },
          hAxis: {
            title: 'Day of Week'
          },
          colors: ['#10b981', '#d1d5db'],
          height: 400,
          chartArea: {
            width: '85%',
            height: '70%'
          }
        };

        // 5. Draw the Chart
        const chart = new google.visualization.ColumnChart(document.getElementById('freeTimeChartDiv'));
        chart.draw(data, options);
    }
});
</script>
</body>
</html>